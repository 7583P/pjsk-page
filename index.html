<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PJSK LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#383838; --panel:#2a2a2a; --panel2:#242424; --ink:#fff; --muted:#bfbfbf;
      --brand:#6c6cf0; --warn:#f0a66c; --ok:#58d68d; --err:#ff6b6b; --line:#0006;
      --row1:#333; --row2:#2a2a2a; --hover:#595959; --chip:#444;
      --rowhLB:56px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    header.topbar{
      background:var(--panel);border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:10
    }
    .topwrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:16px}
    .brand{font-weight:700;letter-spacing:.5px}
    nav.tabs{display:flex;gap:8px;margin-left:16px}
    nav.tabs button{background:transparent;border:1px solid transparent;color:var(--ink);border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
    nav.tabs button.active, nav.tabs button:hover{background:var(--panel2);border-color:#0006}
    .spacer{flex:1}

    .userbox{display:flex;align-items:center;gap:10px}
    .discord-badge{display:flex;align-items:center;gap:6px;background:#5865F2;padding:6px 10px;border-radius:999px;font-weight:600}
    .discord-badge svg{width:16px;height:16px}
    .login-btn,.logout-btn{background:#5865F2;border:none;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700}
    .logout-btn{background:#444}
    .login-btn:hover,.logout-btn:hover{filter:brightness(1.07)}

    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .wrap{padding:18px}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .title{margin:0 0 8px}
    .muted{color:var(--muted)}
    .primary{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .primary:hover{filter:brightness(1.05)}
    .ghost{background:transparent;border:1px solid #0006;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .notice{background:#444;border:1px dashed #666;color:#fff;padding:12px;border-radius:10px}

    /* Leaderboard */
    #lbApp h1{font-size:1.6em;margin:0 0 10px;text-align:center}
    #lbApp .controls{margin-bottom:10px;text-align:center}
    #lbApp .controls input[type="text"]{padding:6px 10px;border-radius:8px;border:1px solid #555;background:#2a2a2a;color:#fff;min-width:260px}
    #lbApp .dropdown{position:relative;display:inline-block;margin-left:10px}
    #lbApp .dropbtn{background:#737373;border:none;padding:6px 12px;border-radius:8px;color:#fff;cursor:pointer;font-weight:bold}
    #lbApp .dropdown-content{position:absolute;top:100%;left:0;min-width:240px;background:#595959;box-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1000;border-radius:8px;overflow:hidden}
    #lbApp .dropdown-content a{display:block;padding:8px 12px;text-decoration:none;font-size:14px;color:#fff}
    #lbApp table{width:100%;border-collapse:collapse;margin-top:10px}
    #lbApp th,#lbApp td{padding:10px;text-align:center;color:#fff}
    #lbApp th{background:#030050}
    #lbApp td{border-bottom:1px solid #555}
    #lbApp tbody tr:nth-child(odd){background:#333}
    #lbApp tbody tr:nth-child(even){background:#2a2a2a}
    #lbApp .position-cell{position:relative;text-align:center;padding-right:120px}
    #lbApp .position-cell .flag{width:24px;position:absolute;top:50%;right:72px;transform:translateY(-50%)}
    #lbApp .position-cell .pfp-sq{
      position:absolute;top:50%;right:8px;transform:translateY(-50%);
      width:calc(var(--rowhLB) - 10px);height:calc(var(--rowhLB) - 10px);
      border-radius:8px;border:1px solid #0007;object-fit:cover;background:#111
    }
    .pagination{margin-top:12px;display:flex;justify-content:center;align-items:center;gap:8px}
    .pagination button{padding:6px 10px;border:none;border-radius:8px;background:#555;color:#fff;cursor:pointer}
    .pagination button:disabled{opacity:.4;cursor:default}
    .pagination input[type="number"]{width:56px;padding:6px;text-align:center;border-radius:8px;border:1px solid #555;background:#2a2a2a;color:#fff}

    .rank-Placement{background-image:linear-gradient(to left,#ff7000,#ff4600)}
    .rank-Iron{background-image:linear-gradient(to left,#616161,#2e2e2e)}
    .rank-Bronze{background-image:linear-gradient(to left,#6d2a00,#3d1d00)}
    .rank-Silver{background-image:linear-gradient(to left,#b3b3b3,#696969)}
    .rank-Gold{background-image:linear-gradient(to left,#ffbf60,#c57600)}
    .rank-Platinum{background-image:linear-gradient(to left,#767ec2,#38429f)}
    .rank-Diamond{background-image:linear-gradient(to left,#42a2ff,#003e8f)}
    .rank-Crystal{background-image:linear-gradient(to left,#dca3ff,#883cb4)}
    .rank-Master{background-image:linear-gradient(to left,#c34efd,#5f009e)}
    .rank-Champion{background-image:linear-gradient(to left,#fe6767,#8f0000)}
    .rank-GrandChampion{background-image:linear-gradient(to left,#ff0800,#570300)}
    .rank-Legend{background-image:linear-gradient(to left,#c9f4ff,#c9f4ff)}

    /* Card picker estilo sekai.best */
    .pfp-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .pfp-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:14px}
    @media (max-width:1100px){ .pfp-grid{grid-template-columns:repeat(5,1fr)} }
    @media (max-width:900px){ .pfp-grid{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:680px){ .pfp-grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:480px){ .pfp-grid{grid-template-columns:repeat(2,1fr)} }
    .card-tile{background:#1f1f1f;border:1px solid #0008;border-radius:12px;overflow:hidden;cursor:pointer;transition:.15s transform, .15s box-shadow}
    .card-tile:hover{transform:translateY(-2px);box-shadow:0 8px 14px rgba(0,0,0,.35)}
    .tile-img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block;background:#111}
    .tile-meta{padding:8px;color:#ddd;display:flex;justify-content:space-between;gap:8px;font-size:.85rem}
    .badge{padding:4px 8px;border-radius:999px;background:#444}
    .danger{color:#ffb3b3}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topwrap">
      <div class="brand">PJSK LOUNGE</div>
      <nav class="tabs" id="tabs">
        <button data-tab="home" class="active">Home</button>
        <button data-tab="leaderboard">Leaderboard</button>
        <button data-tab="edit">Edit Profile</button>
      </nav>
      <div class="spacer"></div>
      <div class="userbox" id="userBox">
        <button class="login-btn" id="btnLogin">
          <!-- Discord icon -->
          <svg viewBox="0 0 245 240" aria-hidden="true" fill="white">
            <path d="M104.4 104.9c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.6-11.1-10.2-11.1zm36.2 0c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.6-11.1-10.2-11.1z"/>
            <path d="M189.5 20h-134C24.3 20 10 34.3 10 51.5v137C10 205.7 24.3 220 41.5 220h113.3l-5.3-18.4 12.8 11.8 12.1 11.2 21.5 19.4V51.5C196 34.3 211.3 20 228.5 20h-39z"/>
          </svg>
          Vincular cuenta con Discord
        </button>
      </div>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="card">
      <div class="wrap">
        <h1 class="title">Welcome to PJSK LOUNGE</h1>
        <p class="muted">PJSK competitive — Discord Bot + Page.</p>
        <div id="homeContent" style="margin-top:12px"></div>
      </div>
    </section>

    <div class="divider"></div>

    <!-- LEADERBOARD -->
    <section id="leaderboard" class="card" style="display:none">
      <div class="wrap">
        <div id="lbApp">
          <h1>PJSK LOUNGE – Leaderboard</h1>

          <div class="controls">
            <input type="text" v-model="filter" placeholder="Buscar por nombre…" v-if="!selectedRank">
            <div class="dropdown" @click.stop>
              <button class="dropbtn" @click.stop="menuOpen = !menuOpen">
                <template v-if="selectedRank">
                  <span class="text-gradient" :class="'rank-'+selectedRank">Filtrar por {{ displayRank(selectedRank) }}</span>
                  <span class="text-gradient" :class="'rank-'+selectedRank">({{ filteredCount }}) ▾</span>
                </template>
                <template v-else>Rangos ▾</template>
              </button>
              <div class="dropdown-content" v-show="menuOpen">
                <a v-for="r in ranks" :key="r.key" href="#" @click.prevent="selectRank(r.key)">
                  <span class="text-gradient" :class="'rank-'+r.key">{{ r.label }} ({{ r.range }})</span>
                </a>
              </div>
            </div>
            <button v-if="selectedRank" @click="clearRank" style="margin-left:10px;background:#555;color:#fff;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;">Mostrar todos ▾</button>
          </div>

          <table>
            <thead>
              <tr><th>#</th><th>Player</th><th>MMR</th><th>Rango</th></tr>
            </thead>
            <tbody>
              <tr v-for="p in paginatedPlayers" :key="p.id" :style="{height:'var(--rowhLB)'}">
                <td class="position-cell">
                  <span>{{ playerRankMap[p.id] }}</span>
                  <img v-if="p.country" :src="flagUrl(p.country)" :alt="p.country" class="flag" />
                  <!-- PFP por Discord ID -->
                  <img v-if="pfpMap[p.discordId]" :src="pfpMap[p.discordId]" alt="pfp" class="pfp-sq" />
                </td>
                <td>
                  <span :class="'rank-'+p.rank" style="background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
                    {{ p.name }}
                  </span>
                </td>
                <td><span :class="'rank-'+p.rank" style="background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{{ p.mmr }}</span></td>
                <td><span :class="'rank-'+p.rank" style="background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{{ displayRank(p.rank) }}</span></td>
              </tr>
            </tbody>
          </table>

          <div class="pagination">
            <button @click="prevPage" :disabled="currentPage<=1">&laquo;</button>
            <input type="number" v-model.number="currentPage" @keyup.enter="goToPage" :min="1" :max="totalPages" />
            <span>/ {{ totalPages }}</span>
            <button @click="nextPage" :disabled="currentPage>=totalPages">&raquo;</button>
          </div>
        </div>
      </div>
    </section>

    <div class="divider"></div>

    <!-- EDIT PROFILE -->
    <section id="edit" class="card" style="display:none">
      <div class="wrap">
        <h2 class="title">Edit Profile (PFP)</h2>
        <div id="editGate"></div>

        <div id="editPanel" style="display:none">
          <div class="notice" style="margin-bottom:12px">
            <strong class="ok">✔</strong> Estás verificado con Discord. Edit PFP habilitado.
          </div>

          <div class="pfp-toolbar">
            <input id="pfpSearch" type="text" placeholder="Buscar carta por nombre/id/asset…" style="min-width:260px">
            <select id="pfpVersion">
              <option value="both">Mostrar: ambas versiones</option>
              <option value="normal">Solo no entrenada</option>
              <option value="trained">Solo entrenada</option>
            </select>
            <button id="btnClearPfp" class="ghost">Eliminar PFP</button>
          </div>

          <div id="pfpInfo" class="notice" style="display:none"></div>
          <div id="pfpGrid" class="pfp-grid"></div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/vue@3"></script>
  <script>
    // ===== Config API =====
    const API_BASE  = ""; // p.ej. "https://tu-api.com" si backend vive en otro dominio
    const URL_ME    = API_BASE + "/api/auth/me";
    const URL_LOGIN = API_BASE + "/api/auth/login";
    const URL_LOGOUT= API_BASE + "/api/auth/logout";
    const URL_PFP   = API_BASE + "/api/pfp";         // GET (mi pfp), POST (set), DELETE (clear)
    const URL_PFPMAP= API_BASE + "/api/pfp-map";     // GET (mapa discordId -> url)

    // ===== Helpers UI =====
    const qs  = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    let currentUser = null;

    function setActiveTab(name){
      qsa("nav.tabs button").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
      qsa("main > section").forEach(s=>s.style.display = (s.id===name) ? "" : "none");
    }
    qs("#tabs").addEventListener("click", e=>{
      if(e.target.tagName==="BUTTON"){ setActiveTab(e.target.dataset.tab); }
    });

    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[s])); }

    function renderUserBox(user){
      const box = qs("#userBox");
      if(!user){
        box.innerHTML = `
          <button class="login-btn" id="btnLogin2">
            <svg viewBox="0 0 245 240" aria-hidden="true" fill="white">
              <path d="M104.4 104.9c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.6-11.1-10.2-11.1zm36.2 0c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.6-11.1-10.2-11.1z"/>
              <path d="M189.5 20h-134C24.3 20 10 34.3 10 51.5v137C10 205.7 24.3 220 41.5 220h113.3l-5.3-18.4 12.8 11.8 12.1 11.2 21.5 19.4V51.5C196 34.3 211.3 20 228.5 20h-39z"/>
            </svg>
            Vincular cuenta con Discord
          </button>`;
        qs("#btnLogin2").onclick = ()=> window.location.href = URL_LOGIN;
      } else {
        const display = user.global_name || user.username;
        box.innerHTML = `
          <div class="discord-badge" title="Conectado con Discord">
            <svg viewBox="0 0 245 240" aria-hidden="true" fill="white">
              <path d="M104.4 104.9c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.6-11.1-10.2-11.1zm36.2 0c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.6-11.1-10.2-11.1z"/>
              <path d="M189.5 20h-134C24.3 20 10 34.3 10 51.5v137C10 205.7 24.3 220 41.5 220h113.3l-5.3-18.4 12.8 11.8 12.1 11.2 21.5 19.4V51.5C196 34.3 211.3 20 228.5 20h-39z"/>
            </svg>
            <span>${escapeHtml(display)}</span>
          </div>
          <button class="logout-btn" id="btnLogoutTop">Logout</button>
        `;
        qs("#btnLogoutTop").onclick = async ()=>{
          await fetch(URL_LOGOUT,{method:"POST",credentials:"include"});
          location.reload();
        }
      }
    }

    function renderHome(user){
      const el = qs("#homeContent");
      if(!user){
        el.innerHTML = `
          <p class="muted">Para usar tu perfil, primero vincula tu cuenta.</p>
          <button class="primary" id="homeLogin">Vincular cuenta con Discord</button>
        `;
        qs("#homeLogin").onclick = ()=> window.location.href = URL_LOGIN;
      } else {
        const display = user.global_name || user.username;
        const avatar = user.avatar_url ? `<img src="${user.avatar_url}" alt="" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:6px;border:1px solid #0006">` : "";
        el.innerHTML = `
          <p>Conectado como ${avatar}<strong>${escapeHtml(display)}</strong> <span class="muted">(Discord)</span>.</p>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="ghost" onclick="document.querySelector('button[data-tab=edit]').click()">Ir a Edit PFP</button>
            <button class="ghost" id="homeLogout">Logout</button>
          </div>
        `;
        qs("#homeLogout").onclick = async ()=>{
          await fetch(URL_LOGOUT,{method:"POST",credentials:"include"});
          location.reload();
        }
      }
    }

    function renderEdit(user){
      const gate = qs("#editGate"), panel = qs("#editPanel");
      if(!user){
        gate.innerHTML = `<div class="notice"><strong class="err">✖</strong> you must be verified on discord to edit pfp</div>`;
        panel.style.display = "none";
      } else {
        gate.innerHTML = "";
        panel.style.display = "";
      }
    }

    async function fetchMe(){
      try{
        const r = await fetch(URL_ME,{credentials:"include"});
        if(!r.ok) return null;
        return await r.json();
      }catch{ return null; }
    }

    // ====== Leaderboard (Vue) ======
    const { createApp } = Vue;
    const PLAYERS_API = "https://worker-production-1ad2.up.railway.app/api/players"; // <-- tu endpoint
    const lbApp = createApp({
      data(){ return {
        players: [], playerRankMap:{}, pfpMap:{}, filter:'', selectedRank:null, menuOpen:false,
        currentPage:1, pageSize:50,
        ranks: [
          { key:'Iron', label:'Iron', range:'0-100' },
          { key:'Bronze', label:'Bronze', range:'101-200' },
          { key:'Silver', label:'Silver', range:'201-300' },
          { key:'Gold', label:'Gold', range:'301-400' },
          { key:'Platinum', label:'Platinum', range:'401-500' },
          { key:'Diamond', label:'Diamond', range:'501-600' },
          { key:'Crystal', label:'Crystal', range:'601-700' },
          { key:'Master', label:'Master', range:'701-800' },
          { key:'Champion', label:'Champion', range:'801-900' },
          { key:'GrandChampion', label:'Grand Champion', range:'901-999' },
          { key:'Legend', label:'Legend', range:'1000+' }
        ]
      }},
      computed:{
        filteredPlayers(){
          let list = this.players;
          if(this.selectedRank) list = list.filter(p => p.rank===this.selectedRank);
          else if(this.filter){
            const q = this.filter.toLowerCase();
            list = list.filter(p => (p.name||"").toLowerCase().includes(q));
          }
          return list;
        },
        filteredCount(){ return this.selectedRank ? this.players.filter(p=>p.rank===this.selectedRank).length : 0; },
        totalPages(){ return Math.max(1, Math.ceil(this.filteredPlayers.length/this.pageSize)); },
        paginatedPlayers(){
          const start = (this.currentPage-1)*this.pageSize;
          return this.filteredPlayers.slice(start, start+this.pageSize);
        }
      },
      watch:{
        filter(){ this.currentPage=1; },
        selectedRank(){ this.currentPage=1; this.filter=''; },
        currentPage(v){ if(v<1)this.currentPage=1; else if(v>this.totalPages)this.currentPage=this.totalPages; }
      },
      methods:{
        selectRank(r){ this.selectedRank=r; this.menuOpen=false; },
        clearRank(){ this.selectedRank=null; },
        prevPage(){ if(this.currentPage>1)this.currentPage--; },
        nextPage(){ if(this.currentPage<this.totalPages)this.currentPage++; },
        goToPage(){},
        async fetchPlayers(){
          try{
            const res = await fetch(PLAYERS_API, { cache:"no-store" });
            const data = await res.json();
            // normalizamos: esperamos p.discordId del backend
            const sorted = (data||[]).map(p=>({
              ...p,
              discordId: p.discordId || p.discord_id || p.did || null
            })).sort((a,b)=>(b.mmr||0)-(a.mmr||0));
            this.players = sorted;
            const map={}; sorted.forEach((p,i)=> map[p.id]=i+1); this.playerRankMap=map;
          }catch(e){
            console.warn("Players API fallback (demo)", e);
            const demo = Array.from({length:40}).map((_,i)=>({
              id:'demo'+i,name:'player'+(i+1),mmr:1000-i*7,rank:['Gold','Platinum','Diamond','Bronze','Silver','Master','Legend'][i%7],
              country:i%2===0?'pe':'us',discordId:'000000000000000'+i
            })).sort((a,b)=>b.mmr-a.mmr);
            const map={}; demo.forEach((p,i)=> map[p.id]=i+1); this.players=demo; this.playerRankMap=map;
          }
        },
        async fetchPfpMap(){
          try{
            const res = await fetch(URL_PFPMAP, { credentials:"include", cache:"no-store" });
            if(res.ok){ this.pfpMap = await res.json(); }
          }catch(e){ console.warn("pfp-map error", e); }
        },
        flagUrl(cc){ return `https://flagcdn.com/24x18/${String(cc||'').toLowerCase()}.png`; },
        displayRank(r){ return r==='GrandChampion'?'Grand Champion':r; },
        onDocClick(e){
          const dd = document.querySelector('#lbApp .dropdown');
          if(!dd?.contains(e.target)) this.menuOpen=false;
        }
      },
      async mounted(){
        await this.fetchPlayers();
        await this.fetchPfpMap();
        this._timer = setInterval(()=>{ this.fetchPlayers(); this.fetchPfpMap(); }, 10000);
        document.addEventListener('click', this.onDocClick);
      },
      unmounted(){
        if(this._timer) clearInterval(this._timer);
        document.removeEventListener('click', this.onDocClick);
      }
    }).mount("#lbApp");

    // ===== PFP Picker (cartas de sekai.best) =====
    const IMAGE_BASES = [
      "https://sekai-res.dnaroma.eu/file/sekai-assets/thumbnail/chara_card/",
      "https://storage.sekai.best/sekai-assets/thumbnail/chara_card/",
    ];
    const CARD_APIS = [
      "https://raw.githubusercontent.com/Sekai-World/sekai-master-db-diff/master/cards.json",
      "https://sekai.best/api/v2/cards.json",
      "https://sekai.best/api/cards.json"
    ];
    const statePFP = { cards:[], filtered:[], version:"both", search:"" };

    function urlsFromAsset(assetbundleName){
      const normal  = `${assetbundleName}_normal.png`;
      const trained = `${assetbundleName}_after_training.png`;
      return { normal: IMAGE_BASES[0]+normal, trained: IMAGE_BASES[0]+trained };
    }
    function normalizeCard(c){
      const asset = c.assetbundleName || c.assetBundleName || c.assetbundle || c.assetBundle;
      const id    = c.id || c.cardId || c.resourceId || c.seq || c.card_id || asset;
      const name  = c.name || c.title || c.cardName || "";
      if(!asset) return null;
      const u = urlsFromAsset(asset);
      return { id: id??asset, name, assetbundleName: asset, imgNormal:u.normal, imgTrained:u.trained };
    }

    function showMsg(el, text){ el.textContent = text; el.style.display = text ? "block" : "none"; }

    async function fetchCards(){
      const info = qs("#pfpInfo");
      showMsg(info,"Cargando cartas…");
      let ok=false, raw=null;
      for(const api of CARD_APIS){
        try{
          const res = await fetch(api, { cache:"no-store", mode:"cors" });
          if(res.ok){ raw = await res.json(); ok=true; break; }
        }catch{}
      }
      if(!ok){ showMsg(info,"No pudimos leer la lista de cartas. Intenta luego."); return; }
      const list = Array.isArray(raw)?raw:(raw.data||raw.cards||raw.result||[]);
      const mapped=[]; for(const it of list){ const m=normalizeCard(it); if(m) mapped.push(m); }
      statePFP.cards = mapped;
      filterCards(); renderCardGrid();
      showMsg(info,`Cartas cargadas: ${mapped.length}.`);
      setTimeout(()=> showMsg(info,""),1200);
    }

    function filterCards(){
      const q = statePFP.search.toLowerCase();
      const ver= statePFP.version;
      statePFP.filtered = statePFP.cards.filter(c=>{
        return (c.name||"").toLowerCase().includes(q) || String(c.id).toLowerCase().includes(q) || c.assetbundleName.toLowerCase().includes(q);
      }).map(c=>{
        if(ver==="normal")  return [{...c,show:"normal"}];
        if(ver==="trained") return [{...c,show:"trained"}];
        return [{...c,show:"normal"},{...c,show:"trained"}];
      }).flat();
    }

    function renderCardGrid(){
      const grid = qs("#pfpGrid");
      if(statePFP.filtered.length===0){ grid.innerHTML = `<div class="muted">Sin resultados.</div>`; return; }
      grid.innerHTML = statePFP.filtered.map(c=>{
        const img = c.show==="trained"?c.imgTrained:c.imgNormal;
        const ver = c.show==="trained" ? "Trained" : "Normal";
        return `
        <div class="card-tile" data-url="${img}">
          <img class="tile-img" loading="lazy" src="${img}" alt="#${c.id}">
          <div class="tile-meta">
            <span class="badge">${ver}</span>
            <span>#${c.id}</span>
          </div>
        </div>`;
      }).join("");
      qsa(".card-tile").forEach(t=>{
        t.addEventListener("click", async ()=>{
          const url = t.dataset.url;
          if(!currentUser){ alert("Vincula tu Discord primero."); return; }
          try{
            const r = await fetch(URL_PFP, {
              method:"POST", credentials:"include",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ url })
            });
            if(!r.ok){ throw new Error("No se pudo guardar el PFP."); }
            alert("PFP actualizado ✔");
            // refrescamos mapa para que se refleje en el leaderboard
            lbApp.fetchPfpMap();
          }catch(e){ alert(e.message||"Error al guardar PFP"); }
        });
      });
    }

    // Controles PFP
    qs("#pfpVersion").addEventListener("change", ()=>{ statePFP.version=qs("#pfpVersion").value; filterCards(); renderCardGrid(); });
    qs("#pfpSearch").addEventListener("input", ()=>{ statePFP.search=qs("#pfpSearch").value.trim().toLowerCase(); filterCards(); renderCardGrid(); });
    qs("#btnClearPfp").addEventListener("click", async ()=>{
      if(!currentUser){ alert("Vincula tu Discord primero."); return; }
      if(!confirm("¿Eliminar tu PFP?")) return;
      await fetch(URL_PFP,{ method:"DELETE", credentials:"include" });
      alert("PFP eliminado.");
      lbApp.fetchPfpMap();
    });

    // ===== Boot =====
    async function init(){
      setActiveTab("home");
      qs("#btnLogin").onclick = ()=> window.location.href = URL_LOGIN;

      currentUser = await fetchMe();
      renderUserBox(currentUser);
      renderHome(currentUser);
      renderEdit(currentUser);

      // si volvimos del callback
      if(location.hash==="#auth=ok"){ history.replaceState({}, "", location.pathname); }

      // cargar cartas al entrar a Edit
      fetchCards();
    }
    init();
  </script>
</body>
</html>


