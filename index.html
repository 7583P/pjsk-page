<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PJSK LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#383838; --panel:#2a2a2a; --panel2:#242424; --ink:#fff; --muted:#bfbfbf;
      --brand:#6c6cf0; --warn:#f0a66c; --ok:#58d68d; --err:#ff6b6b; --line:#0006;
      --row1:#333; --row2:#2a2a2a; --hover:#595959;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    #app{min-height:100%}

    /* Top bar */
    header.topbar{
      position:sticky;top:0;z-index:5;
      background:var(--panel);border-bottom:1px solid var(--line)
    }
    .topbar .wrap{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
    .brand{font-weight:700;letter-spacing:.5px}
    nav.tabs{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap}
    .tabbtn{
      padding:8px 12px;border-radius:8px;background:#0000;border:1px solid #0000;color:var(--ink);
      cursor:pointer;transition:.15s background;
    }
    .tabbtn:hover{background:var(--hover)}
    .tabbtn.active{background:var(--brand);border-color:#0000}

    /* Layout */
    .container{max-width:1100px;margin:20px auto;padding:20px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 0 14px rgba(0,0,0,.35);padding:18px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:900px){ .grid.cols-2{grid-template-columns:1fr} }

    /* Home hero */
    .hero{
      text-align:center;padding:28px;border-radius:12px;background:linear-gradient(135deg,#2a2a2a 0%, #242424 100%);
      border:1px solid var(--line);margin-bottom:16px
    }
    .hero h1{font-size:clamp(28px,5vw,48px);margin:0 0 6px}
    .hero p{margin:0;color:var(--muted)}

    /* Forms */
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{font-size:.92rem;color:var(--muted)}
    input{
      padding:10px 12px;border-radius:10px;border:1px solid #0008;background:var(--panel2);color:var(--ink);
      outline:none
    }
    input:focus{border-color:var(--brand)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:10px;border:1px solid #0000;background:var(--brand);color:#fff;
      cursor:pointer;font-weight:600
    }
    .btn.ghost{background:#0000;border-color:#00000055}
    .btn.warn{background:var(--warn);color:#000}
    .btn.full{width:100%}

    .help{font-size:.9rem;color:var(--muted)}
    .msg{padding:10px 12px;border-radius:10px;margin:10px 0;font-size:.95rem}
    .msg.ok{background:#1e3b2e;color:#d6ffe7;border:1px solid #2a6c4b}
    .msg.err{background:#3b1e1e;color:#ffd6d6;border:1px solid #6c2a2a}
    .msg.info{background:#1e263b;color:#d6e4ff;border:1px solid #2a3f6c}

    /* Sections */
    section{display:none}
    section.active{display:block}

    /* Leaderboard */
    table{width:100%;border-collapse:collapse;border-spacing:0}
    thead th{font-weight:700;text-align:left;padding:12px;border-bottom:1px solid #444}
    tbody tr:nth-child(odd){background:var(--row1)}
    tbody tr:nth-child(even){background:var(--row2)}
    tbody td{padding:10px 12px;border-bottom:1px solid #444}
    .discord-fail{color:var(--err);font-weight:700}
    .rank-chip{
      display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;background:#444;color:#fff
    }

    .banner{margin:12px 0}
  </style>
</head>
<body>
<div id="app">
  <header class="topbar">
    <div class="wrap">
      <div class="brand">PJSK LOUNGE</div>
      <nav class="tabs">
        <button class="tabbtn active" data-tab="home">Home</button>
        <button class="tabbtn" data-tab="leaderboard">Leaderboard</button>
        <button class="tabbtn" data-tab="profile">Edit Profile</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="home" class="active">
      <div class="hero card">
        <h1>Welcome to PJSK LOUNGE</h1>
        <p>New project of competitive PJSK with a Discord bot and a dedicated page.</p>
      </div>

      <div id="authArea" class="grid cols-2">
        <!-- Login -->
        <div class="card">
          <h2 style="margin:0 0 10px">Iniciar sesión</h2>
          <div class="field">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="tu@email.com" autocomplete="username" />
          </div>
          <div class="field">
            <label for="loginPass">Contraseña</label>
            <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password" />
          </div>
          <button id="btnLogin" class="btn full">Entrar</button>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <button id="btnReset" class="btn ghost">Reset password</button>
            <span class="help">¿Sin verificar? <a href="#" id="btnResendFromLogin">Reenviar verificación</a></span>
          </div>
          <div id="loginMsg"></div>
        </div>

        <!-- Register -->
        <div class="card">
          <h2 style="margin:0 0 10px">Crear cuenta</h2>
          <div class="field">
            <label for="regDisplay">Nombre a mostrar (opcional)</label>
            <input id="regDisplay" type="text" placeholder="Tu nickname" />
          </div>
          <div class="field">
            <label for="regEmail">Email</label>
            <input id="regEmail" type="email" placeholder="tu@email.com" autocomplete="email" />
          </div>
          <div class="field">
            <label for="regPass">Contraseña</label>
            <input id="regPass" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />
          </div>
          <button id="btnRegister" class="btn full">Registrarme</button>
          <div id="regMsg"></div>
        </div>
      </div>

      <div id="welcomeArea" class="card" style="display:none">
        <h2 style="margin:0 0 6px">¡Hola, <span id="welcomeName">Usuario</span>!</h2>
        <p class="help" style="margin:0 0 12px">Ya iniciaste sesión.</p>
        <div id="verifyBanner" class="banner" style="display:none"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="btnLogout" class="btn">Cerrar sesión</button>
          <button id="btnGoProfile" class="btn ghost">Ir a Edit Profile</button>
          <button id="btnResendVerify" class="btn warn" style="display:none">Reenviar verificación</button>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="leaderboard">
      <div class="card">
        <h2 style="margin:0 0 10px">Leaderboard</h2>
        <p class="help" style="margin:0 0 10px">Ordenado por puntaje. Si el nombre de Discord no está verificado o es inválido, se mostrará <span class="discord-fail">“failed to verificate”</span>.</p>
        <div id="lbMsg" class="msg info" style="display:none"></div>
        <div style="overflow:auto;border-radius:10px;border:1px solid #0006">
          <table id="lbTable">
            <thead>
              <tr>
                <th style="width:70px">#</th>
                <th>Jugador</th>
                <th style="width:140px">Rango</th>
                <th style="width:120px">Puntaje</th>
              </tr>
            </thead>
            <tbody id="lbBody">
              <tr><td colspan="4" style="text-align:center;padding:16px">Cargando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile">
      <div class="card">
        <h2 style="margin:0 0 10px">Editar perfil</h2>
        <p class="help" style="margin:0 0 14px">Actualiza tu nombre a mostrar y tu nombre de usuario de Discord.</p>
        <div class="grid cols-2">
          <div>
            <div class="field">
              <label for="pfDisplay">Nombre a mostrar</label>
              <input id="pfDisplay" type="text" placeholder="Tu nickname" />
            </div>
            <div class="field">
              <label for="pfDiscord">Discord username</label>
              <input id="pfDiscord" type="text" placeholder="ej. diego.carbajal o diego#1234" />
            </div>
            <button id="btnSaveProfile" class="btn">Guardar</button>
            <div id="pfMsg"></div>
          </div>
          <div>
            <div class="msg info">
              <strong>Verificación de Discord:</strong><br/>
              Marcamos tu Discord como <em>verificado</em> si pasa una validación básica de formato (usuario nuevo sin # o formato antiguo <code>name#1234</code>).<br/>
              Si no pasa, en el leaderboard verás <span class="discord-fail">failed to verificate</span>.
            </div>
            <div id="emailState" class="msg" style="display:none"></div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Firebase (modular) -->
<script type="module">
  // ==== IMPORTS ====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    sendEmailVerification, sendPasswordResetEmail, signOut, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, updateDoc, getDoc, getDocs, collection, serverTimestamp,
    query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ==== CONFIGURA TUS CREDENCIALES ====
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_BUCKET",
    messagingSenderId: "TU_SENDER_ID",
    appId: "TU_APP_ID",
  };

  // ==== INIT ====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ==== UI helpers ====
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const setActiveTab = (name) => {
    $$(".tabbtn").forEach(b => b.classList.toggle("active", b.dataset.tab===name));
    $$("main section").forEach(s => s.classList.toggle("active", s.id===name));
  };
  $$(".tabbtn").forEach(b => b.addEventListener("click", ()=> setActiveTab(b.dataset.tab)));

  function showMsg(el, text, type){
    el.className = "msg " + (type||"info");
    el.textContent = text;
    el.style.display = text ? "block" : "none";
  }
  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  // Discord: acepta nuevo formato (sin #) y legacy con #1234
  function validateDiscordUsername(u){
    if(!u) return false;
    u = u.trim();
    if(u.startsWith("@")) u = u.slice(1);
    const legacy = /^[^\s@#]{2,32}#[0-9]{4}$/;               // name#1234
    const modern = /^[a-zA-Z0-9._]{2,32}$/;                  // nuevo formato
    return legacy.test(u) || modern.test(u);
  }

  // ==== AUTH: REGISTER ====
  $("#btnRegister").addEventListener("click", async ()=>{
    const email = $("#regEmail").value.trim();
    const pass  = $("#regPass").value.trim();
    const display = $("#regDisplay").value.trim();
    const el = $("#regMsg");
    showMsg(el, "", "info");

    if(!email || !pass){
      showMsg(el, "Completa email y contraseña.", "err"); return;
    }
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      if(display){
        await updateProfile(cred.user, { displayName: display });
      }
      // Crear doc base del usuario en Firestore
      await setDoc(doc(db, "users", cred.user.uid), {
        uid: cred.user.uid,
        email,
        displayName: display || "",
        discord: "",
        discordVerified: false,
        score: 0,
        rank: "Unranked",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });

      // Enviar verificación inmediatamente (arregla “no enviaba”)
      await sendEmailVerification(cred.user);
      showMsg(el, "Te enviamos un correo de verificación. Revisa tu bandeja y spam.", "ok");

      // Limpieza
      $("#regPass").value = "";
    }catch(err){
      const map = {
        "auth/email-already-in-use": "Ese email ya está registrado.",
        "auth/invalid-email": "Email inválido.",
        "auth/weak-password": "La contraseña es muy débil (mínimo 6)."
      };
      showMsg(el, map[err.code] || ("Error al registrar: " + err.message), "err");
    }
  });

  // ==== AUTH: LOGIN ====
  $("#btnLogin").addEventListener("click", async ()=>{
    const email = $("#loginEmail").value.trim();
    const pass  = $("#loginPass").value.trim();
    const el = $("#loginMsg");
    showMsg(el, "", "info");
    if(!email || !pass){ showMsg(el, "Completa email y contraseña.", "err"); return; }

    try{
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      if(!cred.user.emailVerified){
        showMsg(el, "Login exitoso, pero tu correo no está verificado. Puedes reenviar el correo de verificación.", "info");
      }else{
        showMsg(el, "", "info");
      }
    }catch(err){
      const map = {
        "auth/invalid-email": "Email inválido.",
        "auth/user-disabled": "Usuario deshabilitado.",
        "auth/user-not-found": "No existe una cuenta con ese email.",
        "auth/wrong-password": "Contraseña incorrecta."
      };
      showMsg(el, map[err.code] || ("Error al iniciar sesión: " + err.message), "err");
    }
  });

  // Reset password
  $("#btnReset").addEventListener("click", async ()=>{
    const email = $("#loginEmail").value.trim() || prompt("Escribe tu email para enviar el reset:");
    if(!email) return;
    try{
      await sendPasswordResetEmail(auth, email);
      showMsg($("#loginMsg"), "Te enviamos un correo para resetear tu contraseña.", "ok");
    }catch(err){
      showMsg($("#loginMsg"), "No pudimos enviar el reset: " + err.message, "err");
    }
  });

  // Reenviar verificación (desde login)
  $("#btnResendFromLogin").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(!auth.currentUser){ showMsg($("#loginMsg"), "Primero inicia sesión para reenviar verificación.", "err"); return; }
    try{
      await sendEmailVerification(auth.currentUser);
      showMsg($("#loginMsg"), "Correo de verificación reenviado.", "ok");
    }catch(err){
      showMsg($("#loginMsg"), "No se pudo reenviar: " + err.message, "err");
    }
  });

  // ==== AUTH STATE ====
  onAuthStateChanged(auth, async (user)=>{
    const authArea = $("#authArea");
    const welcomeArea = $("#welcomeArea");
    if(user){
      // UI de bienvenida
      authArea.style.display = "none";
      welcomeArea.style.display = "block";
      $("#welcomeName").textContent = user.displayName || (user.email?.split("@")[0]) || "Usuario";
      // Banner de verificación
      const vb = $("#verifyBanner");
      const btnResend = $("#btnResendVerify");
      if(user.emailVerified){
        vb.style.display = "none";
        btnResend.style.display = "none";
      }else{
        vb.style.display = "block";
        vb.className = "msg info banner";
        vb.innerHTML = "Tu correo aún no está verificado. Revisa tu bandeja o <strong>reenvía la verificación</strong>.";
        btnResend.style.display = "inline-flex";
      }
      // Rellena perfil
      await hydrateProfileForm(user.uid);
      // Actualiza emailState en perfil
      updateEmailState(user);
    }else{
      welcomeArea.style.display = "none";
      authArea.style.display = "grid";
      updateEmailState(null);
    }
    // Siempre refresca el leaderboard al cambiar el estado (por si score o discord)
    renderLeaderboard();
  });

  $("#btnResendVerify").addEventListener("click", async ()=>{
    if(!auth.currentUser) return;
    try{
      await sendEmailVerification(auth.currentUser);
      showMsg($("#verifyBanner"), "Correo de verificación reenviado.", "ok");
    }catch(err){
      showMsg($("#verifyBanner"), "No se pudo reenviar: " + err.message, "err");
    }
  });

  $("#btnLogout").addEventListener("click", async ()=>{
    await signOut(auth);
  });
  $("#btnGoProfile").addEventListener("click", ()=> setActiveTab("profile"));

  // ==== PROFILE ====
  async function hydrateProfileForm(uid){
    try{
      const snap = await getDoc(doc(db, "users", uid));
      if(snap.exists()){
        const d = snap.data();
        $("#pfDisplay").value = d.displayName || "";
        $("#pfDiscord").value = d.discord || "";
      }
    }catch{ /* ignore */ }
  }

  function updateEmailState(user){
    const el = $("#emailState");
    if(!user){ el.style.display = "none"; return; }
    el.style.display = "block";
    if(user.emailVerified){
      el.className = "msg ok";
      el.textContent = "Tu correo está verificado ✅";
    }else{
      el.className = "msg info";
      el.textContent = "Tu correo NO está verificado. Algunas funciones pueden estar limitadas.";
    }
  }

  $("#btnSaveProfile").addEventListener("click", async ()=>{
    const u = auth.currentUser;
    const el = $("#pfMsg");
    if(!u){ showMsg(el, "Inicia sesión para guardar.", "err"); return; }

    const display = $("#pfDisplay").value.trim();
    const discord  = $("#pfDiscord").value.trim();
    const discordVerified = validateDiscordUsername(discord);

    try{
      if(display && display !== (u.displayName||"")){
        await updateProfile(u, { displayName: display });
      }
      await updateDoc(doc(db, "users", u.uid), {
        displayName: display,
        discord,
        discordVerified,
        updatedAt: serverTimestamp()
      });
      showMsg(el, "Perfil actualizado.", "ok");
      renderLeaderboard();
    }catch(err){
      // Si no existe el doc aún (usuario antiguo), lo creamos
      if(err.code === "not-found"){
        try{
          await setDoc(doc(db,"users",u.uid), {
            uid: u.uid, email: u.email, displayName: display, discord, discordVerified,
            score: 0, rank: "Unranked", createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
          showMsg(el, "Perfil creado.", "ok");
          renderLeaderboard();
        }catch(e2){
          showMsg(el, "No se pudo guardar: " + e2.message, "err");
        }
      }else{
        showMsg(el, "No se pudo guardar: " + err.message, "err");
      }
    }
  });

  // ==== LEADERBOARD ====
  async function renderLeaderboard(){
    const body = $("#lbBody");
    body.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:16px">Cargando…</td></tr>`;
    try{
      // Si no tienes muchos usuarios, puedes quitar limit(100)
      const qy = query(collection(db,"users"), orderBy("score","desc"), limit(100));
      const snap = await getDocs(qy);
      let idx = 0;
      let rows = "";
      snap.forEach(docu=>{
        const d = docu.data();
        idx++;
        const rank = d.rank || "Unranked";
        const score = Number(d.score||0);
        const discord = (d.discord||"").trim();
        const verifiedFlag = !!d.discordVerified;
        const validByFormat = validateDiscordUsername(discord);
        const showFail = !(verifiedFlag && validByFormat);
        const playerCell = showFail ? `<span class="discord-fail">failed to verificate</span>`
                                    : `<span>${escapeHtml(discord)}</span>`;
        rows += `
          <tr>
            <td>${idx}</td>
            <td>${playerCell}</td>
            <td><span class="rank-chip">${escapeHtml(rank)}</span></td>
            <td>${score}</td>
          </tr>`;
      });
      body.innerHTML = rows || `<tr><td colspan="4" style="text-align:center;padding:16px">Sin datos</td></tr>`;
      $("#lbMsg").style.display = "none";
    }catch(err){
      body.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:16px">No se pudo cargar el leaderboard.</td></tr>`;
      showMsg($("#lbMsg"), "Error al cargar leaderboard: " + err.message, "err");
    }
  }

  // Primera carga por si el usuario ya está autenticado (onAuthStateChanged disparará de todos modos)
  renderLeaderboard();
</script>
</body>
</html>



