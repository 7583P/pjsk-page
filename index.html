<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PJSK LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#383838; --panel:#2a2a2a; --text:#fff; --muted:#bfbfbf;
      --chip:#737373; --hover:#595959; --row1:#2f2f2f; --row2:#262626;
      --accent:#6c6cf0; --warn:#f0a66c; --head:#00124f; --headTxt:#fff;
      --mmr:#7b8bff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    #app{min-height:100%}

    header.topbar{background:var(--panel);border-bottom:1px solid #0006;position:sticky;top:0;z-index:10}
    .nav{max-width:1000px;margin:0 auto;display:flex;gap:14px;align-items:center;padding:12px}
    .nav a{padding:8px 10px;border-radius:8px}
    .nav a.active{background:#444}
    .nav a:hover{background:var(--hover)}
    .grow{flex:1}
    .container{max-width:1000px;margin:20px auto;padding:20px;background:var(--panel);border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.45)}

    .btn{background:#5050ff1f;border:1px solid var(--accent);border-radius:8px;padding:8px 12px;color:#cfd0ff;cursor:pointer}
    .btn:hover{background:#6c6cf02f}
    .btn.ghost{background:transparent;border-color:#777;color:#ddd}
    .btn.warn{border-color:var(--warn);color:#ffd9c0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    .card{background:#1f1f1f;border:1px solid #3a3a3a;border-radius:12px;padding:12px}
    .input{background:#1f1f1f;border:1px solid #555;color:#fff;border-radius:8px;padding:8px 10px;width:100%}
    .help{color:var(--muted);font-size:13px}
    .badge{display:inline-grid;place-items:center;border:1px solid #555;color:#bbb;padding:3px 8px;border-radius:999px;font-size:12px}

    .hero{font-size:30px;margin:0 0 10px;text-align:center}
    .welcome-block{white-space:pre-wrap;background:#1a1a1a;border:1px solid #333;padding:16px;border-radius:12px;font-family:inherit}
    .center{ text-align:center }

    /* PFP UI */
    .pfp-box{width:220px;height:220px;background:#303030;border:2px dashed #555;border-radius:12px;display:grid;place-items:center;overflow:hidden}
    .pfp-box img{width:100%;height:100%;object-fit:cover}
    .grid.cards{grid-template-columns:repeat(auto-fill,minmax(130px,1fr))}
    .cardbtn{padding:8px;text-align:center;cursor:pointer}
    .cardbtn.selected{outline:2px solid var(--accent);border-radius:10px}

    /* Leaderboard */
    .page-title{font-size:34px;margin:0 0 14px;text-align:center;letter-spacing:.3px}
    .toolbar{display:flex;gap:10px;justify-content:center;margin-bottom:10px}
    .toolbar .input{max-width:380px}
    .toolbar select{appearance:none;background:#1f1f1f;border:1px solid #555;color:#fff;border-radius:8px;padding:8px 10px}
    table.tbl{width:100%;border-collapse:separate;border-spacing:0 0}
    table.tbl thead th{background:var(--head);color:var(--headTxt);padding:10px;border-top-left-radius:6px;border-top-right-radius:6px}
    table.tbl tbody td{padding:10px;border-bottom:1px solid #333}
    table.tbl tbody tr:nth-child(odd){background:var(--row1)}
    table.tbl tbody tr:nth-child(even){background:var(--row2)}
    .col-num{width:56px;text-align:center;opacity:.8}
    .col-mmr{color:var(--mmr);font-weight:600;text-align:right;width:120px}
    .col-rank{width:150px}
    .player-cell{display:flex;align-items:center;gap:10px}
    .player-cell img{width:26px;height:26px;border-radius:6px;object-fit:cover}
    .rank-chip{font-weight:600}
    .rank-Diamond{color:#66a3ff}
    .rank-Platinum{color:#9fa6ff}
    .rank-Gold{color:#ffb74d}
    .rank-Silver{color:#cfd8dc}
    .rank-Bronze{color:#cd7f32}
    .rank-Iron{color:#9e9e9e}
    .rank-Placement{color:#ff9b4d}
  </style>
</head>
<body>
<div id="app">
  <header class="topbar">
    <nav class="nav">
      <a href="#/" data-route>Home</a>
      <a href="#/edit-profile" data-route>Edit Profile</a>
      <a href="#/pjsk-lounge" data-route>PJSK LOUNGE</a>
      <div class="grow"></div>
      <div id="authStatus" class="row"></div>
    </nav>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="route-home" class="grid" style="gap:18px;display:none">
      <div>
        <h1 class="hero">Welcome to PJSK LOUNGE</h1>
        <div class="welcome-block">
PJSK LOUNGE, new project of competitive pjsk with a DISCORD BOT and PAGE especially created for this project (11/05/25)
How it works?
first of all, the format is 1v1v1v1v1 (2-4 available for now) into a CO-OP with 5 ROUNDS, the amount of perfect,great,good,bad and miss taps will be counted and if u are placement depending on your amount from great to miss taps will determine your starting rank (there are 11 ranks) after the room in discord is full the bot will launch random songs to be selected on HARD/EXPERT/MASTER/APPEND difficulty according to your rank, once the 5 rounds are finished !submit command will be use to update MMR/RANK/ROLES into DISCORD and into the PAGE there are COMMANDS to join a room, leave a room, check top 10, check your mmr (and mmr/rank from other player), check your x season stats/current seasons stats, etc if you are new into the game or you are a top player dosnt matter, any skill is welcome
        </div>
      </div>

      <div class="card">
        <div id="homeButtons" class="row"></div>
        <p id="homeHint" class="help"></p>
      </div>

      <!-- Modales simples -->
      <div id="panel-register" class="card grid" style="gap:10px;display:none">
        <h3>Register</h3>
        <input class="input" id="regEmail" placeholder="Email" type="email">
        <input class="input" id="regPass" placeholder="Password" type="password">
        <div class="row">
          <button class="btn" id="btnDoRegister">Crear cuenta</button>
          <button class="btn ghost" data-close="panel-register">Cancelar</button>
        </div>
        <p class="help">Recibirás un correo con botón/enlace de verificación.</p>
        <p id="msgRegister" class="help"></p>
      </div>

      <div id="panel-login" class="card grid" style="gap:10px;display:none">
        <h3>Login</h3>
        <input class="input" id="logEmail" placeholder="Email" type="email">
        <input class="input" id="logPass" placeholder="Password" type="password">
        <div class="row">
          <button class="btn" id="btnDoLogin">Entrar</button>
          <button class="btn ghost" data-close="panel-login">Cancelar</button>
        </div>
        <p id="msgLogin" class="help"></p>
      </div>

      <div id="panel-reset" class="card grid" style="gap:10px;display:none">
        <h3>Reset password</h3>
        <input class="input" id="resetEmail" placeholder="Tu correo" type="email">
        <div class="row">
          <button class="btn" id="btnDoReset">Enviar email</button>
          <button class="btn ghost" data-close="panel-reset">Cancelar</button>
        </div>
        <p class="help">Si no existe cuenta, te enviaremos instrucciones para registrarte.</p>
        <p id="msgReset" class="help"></p>
      </div>
    </section>

    <!-- EDIT PROFILE -->
    <section id="route-edit" class="grid" style="gap:18px;display:none">
      <h2>Edit Profile</h2>
      <div id="edit-loading">Cargando…</div>

      <div id="edit-guest" class="card grid" style="gap:10px;display:none">
        <p class="help">No has iniciado sesión.</p>
        <div class="row">
          <button class="btn" data-open="panel-register">Register</button>
          <button class="btn ghost" data-open="panel-login">Login</button>
          <button class="btn ghost" data-open="panel-reset">Reset password</button>
        </div>
      </div>

      <div id="edit-unverified" class="card grid" style="gap:10px;display:none">
        <p><strong>Verifica tu correo para continuar</strong></p>
        <p class="help">Te hemos enviado un email con un botón/enlace de verificación.</p>
        <div class="row">
          <button class="btn" id="btnResend">Resend verification</button>
          <button class="btn ghost" id="btnReload">Refrescar estado</button>
        </div>
        <p id="msgEditUnv" class="help"></p>
      </div>

      <div id="edit-verified" class="grid" style="gap:14px;display:none">
        <div class="card grid" style="gap:10px">
          <label>Name (read-only)</label>
          <input class="input" id="displayNameRO" readonly />
        </div>

        <div class="grid" style="gap:14px">
          <h3>set pfp in game cards</h3>
          <div class="row" style="align-items:flex-start">
            <div class="pfp-box" id="pfpBox"><span class="help">(sin PFP)</span></div>
            <div class="card" style="flex:1">
              <div id="cardsGrid" class="grid cards"></div>
              <div class="row" style="margin-top:10px">
                <button class="btn warn" id="btnDeletePfp">Delete pfp</button>
              </div>
              <p id="msgPfp" class="help"></p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PJSK LOUNGE -->
    <section id="route-lounge" class="grid" style="gap:12px;display:none">
      <h2 class="page-title">PJSK LOUNGE — Season Beta</h2>

      <div class="toolbar">
        <input id="searchName" class="input" placeholder="Buscar por nombre…">
        <select id="rankFilter" title="Rangos">
          <option value="">All Ranges</option>
          <option>Diamond</option><option>Platinum</option><option>Gold</option>
          <option>Silver</option><option>Bronze</option><option>Iron</option>
          <option>Placement</option>
        </select>
      </div>

      <div class="card">
        <table class="tbl">
          <thead>
            <tr>
              <th class="col-num">#</th>
              <th>Player</th>
              <th class="col-mmr">MMR</th>
              <th class="col-rank">Rango</th>
            </tr>
          </thead>
          <tbody id="playersTbody"><tr><td colspan="4" class="help">—</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Firebase SDK (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification,
    sendPasswordResetEmail, signOut, updateProfile, reload
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, writeBatch, onSnapshot, collection, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  /* ======= TU CONFIG FIREBASE ======= */
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  // Persistencia fuerte: mantiene sesión en redeploys mientras el origen sea el mismo
  await setPersistence(auth, browserLocalPersistence);

  /* ====== Utils ====== */
  const $  = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  function setActiveRoute(){
    const h = location.hash || "#/";
    $$('a[data-route]').forEach(a => a.classList.toggle('active', a.getAttribute('href')===h));
  }
  function showRoute(el){
    $("#route-home").style.display="none";
    $("#route-edit").style.display="none";
    $("#route-lounge").style.display="none";
    el && (el.style.display="");
    setActiveRoute();
  }
  const RANKS = ["Diamond","Platinum","Gold","Silver","Bronze","Iron","Placement"];

  /* ====== Cards mock (SVG data URLs) ====== */
  const CARDS = [
    { id:"c1", name:"Miku — Sky Blue", rarity:"SSR", imageUrl: svg("Sky","0,180,255","#7bdfff") },
    { id:"c2", name:"Miku — Neon Heart", rarity:"SR", imageUrl: svg("Neon","255,0,120","#ff79c6") },
    { id:"c3", name:"Ichika — Blossom", rarity:"SR", imageUrl: svg("Blossom","255,100,180","#ffaad4") },
    { id:"c4", name:"Honami — Ocean", rarity:"R", imageUrl: svg("Ocean","20,90,255","#7aa2ff") },
    { id:"c5", name:"Shiho — Night Drive", rarity:"R", imageUrl: svg("Night","30,30,60","#9aa0ff") },
    { id:"c6", name:"Saki — Sunshine", rarity:"R", imageUrl: svg("Sun","255,210,0","#ffe680") },
    { id:"c7", name:"Emu — Pop Star", rarity:"N", imageUrl: svg("Pop","255,0,200","#ffb3ff") },
    { id:"c8", name:"Nene — Mint", rarity:"N", imageUrl: svg("Mint","0,200,140","#8affd1") },
  ];
  function svg(label,rgb,chip){
    const enc = s=>encodeURIComponent(s).replace(/%20/g,' ');
    const raw = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='800'>
      <defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='rgba(${rgb},1)'/><stop offset='100%' stop-color='rgba(${rgb},0.6)'/>
      </linearGradient></defs>
      <rect width='100%' height='100%' fill='url(#g)'/>
      <circle cx='520' cy='60' r='34' fill='${chip}' />
      <text x='24' y='740' font-size='36' font-family='Arial' fill='white'>${label}</text>
    </svg>`;
    return `data:image/svg+xml;utf8,${enc(raw)}`;
  }

  /* ====== Global State ====== */
  let currentUser = null;
  let currentProfile = null;
  let playersCache = [];   // para búsqueda/filtro
  let loungeUnsub = null;

  /* ====== Router ====== */
  function render(){
    const h = location.hash || "#/";
    if (h.startsWith("#/edit-profile")){ showRoute($("#route-edit")); renderEdit(); }
    else if (h.startsWith("#/pjsk-lounge")){ showRoute($("#route-lounge")); renderLounge(); }
    else { showRoute($("#route-home")); renderHome(); }
  }
  window.addEventListener("hashchange", render);

  /* ====== Header ====== */
  function updateHeader(){
    const box = $("#authStatus"); box.innerHTML="";
    if (currentUser){
      const badge = document.createElement("span"); badge.className="badge"; badge.textContent=currentUser.email;
      const b = document.createElement("button"); b.className="btn ghost"; b.textContent="Log out";
      b.onclick = async()=>{ await signOut(auth); location.hash="#/"; };
      box.append(badge,b);
    } else {
      const reg=aBtn("Register","#/"); const log=aBtn("Login","#/");
      box.append(reg,log);
    }
    function aBtn(txt,href){ const a=document.createElement("a"); a.className="btn ghost"; a.href=href; a.textContent=txt; return a; }
  }

  /* ====== Home ====== */
  function renderHome(){
    const hb = $("#homeButtons"), hint=$("#homeHint");
    $("#panel-register").style.display="none";
    $("#panel-login").style.display="none";
    $("#panel-reset").style.display="none";
    $("#msgRegister").textContent=""; $("#msgLogin").textContent=""; $("#msgReset").textContent="";
    hb.innerHTML="";
    if (!currentUser){
      hb.append(btn("Register", ()=>openPanel("panel-register")),
                btn("Login", ()=>openPanel("panel-login"),"ghost"),
                btn("Reset password", ()=>openPanel("panel-reset"),"ghost"));
      hint.textContent="También puedes usar Edit Profile para acceder a Register/Login/Reset.";
    } else {
      hb.append(btn("Log out", async()=>{ await signOut(auth); },"warn"));
      hint.textContent="Sigue en Edit Profile para configurar tu PFP.";
    }
  }
  function btn(t,fn,v=""){ const b=document.createElement("button"); b.className="btn"+(v?` ${v}`:""); b.textContent=t; b.onclick=fn; return b; }
  function openPanel(id){ $("#"+id).style.display=""; }
  $$("#route-home [data-close]").forEach(el=> el.addEventListener("click", ()=> $("#"+el.getAttribute("data-close")).style.display="none"));

  $("#btnDoRegister").addEventListener("click", async ()=>{
    const email=$("#regEmail").value.trim(), pass=$("#regPass").value;
    $("#msgRegister").textContent="";
    try{
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      const displayName = email.split("@")[0];
      await updateProfile(cred.user,{ displayName });
      await sendEmailVerification(cred.user);
      const batch = writeBatch(db), now=new Date().toISOString();
      batch.set(doc(db,"player_profiles", cred.user.uid), { user_id: cred.user.uid, pfp_card_id:null, mmr:0, rank:"Placement", updated_at:now });
      batch.set(doc(db,"public_players", cred.user.uid), { display_name: displayName, mmr:0, rank:"Placement", pfp_card_id:null, pfp_image:null });
      await batch.commit();
      $("#msgRegister").textContent="Cuenta creada. Revisa tu correo para verificar tu cuenta.";
      $("#panel-register").style.display="none";
    }catch(e){ $("#msgRegister").textContent=e.message; }
  });

  $("#btnDoLogin").addEventListener("click", async ()=>{
    const email=$("#logEmail").value.trim(), pass=$("#logPass").value;
    $("#msgLogin").textContent="";
    try{
      const { user } = await signInWithEmailAndPassword(auth,email,pass);
      if(!user.emailVerified){ $("#msgLogin").textContent="Tu correo no está verificado. Usa 'Resend verification' en Edit Profile."; }
      else { $("#msgLogin").textContent="Login correcto."; $("#panel-login").style.display="none"; location.hash="#/edit-profile"; }
    }catch(e){ $("#msgLogin").textContent=e.message; }
  });

  $("#btnDoReset").addEventListener("click", async ()=>{
    const email=$("#resetEmail").value.trim(); $("#msgReset").textContent="";
    try{ await sendPasswordResetEmail(auth,email);
      $("#msgReset").textContent="Si existe una cuenta, te enviamos instrucciones. Si no, te guiaremos a registrarte.";
      $("#panel-reset").style.display="none";
    }catch(e){ $("#msgReset").textContent=e.message; }
  });

  /* ====== Edit ====== */
  async function renderEdit(){
    $("#edit-loading").style.display="";
    $("#edit-guest").style.display="none"; $("#edit-unverified").style.display="none"; $("#edit-verified").style.display="none";
    $("#msgPfp").textContent=""; $("#msgEditUnv").textContent="";
    if(!currentUser){ $("#edit-loading").style.display="none"; $("#edit-guest").style.display=""; return; }
    await reload(currentUser);
    const isVerified = !!currentUser.emailVerified;
    $("#edit-loading").style.display="none";
    if(!isVerified){ $("#edit-unverified").style.display=""; return; }
    $("#edit-verified").style.display="";
    $("#displayNameRO").value = currentUser.displayName || (currentUser.email?.split("@")[0] ?? "Player");
    await loadProfileAndPfp();
    const grid=$("#cardsGrid"); grid.innerHTML="";
    for(const c of CARDS){
      const b=document.createElement("button"); b.className="card cardbtn";
      b.innerHTML = `<img alt="card" src="${c.imageUrl}" style="width:100%;height:150px;object-fit:cover;border-radius:8px"/>
                     <div style="margin-top:6px;font-size:13px;color:#ddd">${c.name} — ${c.rarity}</div>`;
      if(currentProfile?.pfp_card_id===c.id) b.classList.add("selected");
      b.onclick = ()=> setPfp(c);
      grid.appendChild(b);
    }
  }
  async function loadProfileAndPfp(){
    const snap = await getDoc(doc(db,"player_profiles", currentUser.uid));
    currentProfile = snap.exists()? snap.data(): null;
    const pfpBox=$("#pfpBox"); pfpBox.innerHTML="";
    if(currentProfile?.pfp_card_id){
      const card = CARDS.find(x=>x.id===currentProfile.pfp_card_id);
      if(card){ const img=new Image(); img.src=card.imageUrl; img.alt="pfp"; pfpBox.appendChild(img); }
      else { pfpBox.innerHTML = `<span class="help">(PFP desconocido)</span>`; }
    } else { pfpBox.innerHTML=`<span class="help">(sin PFP)</span>`; }
  }
  async function setPfp(card){
    try{
      const batch = writeBatch(db), now=new Date().toISOString();
      batch.set(doc(db,"player_profiles", currentUser.uid), {
        user_id: currentUser.uid, pfp_card_id: card.id, mmr: currentProfile?.mmr ?? 0, rank: currentProfile?.rank ?? "Placement", updated_at: now
      }, { merge:true });
      batch.set(doc(db,"public_players", currentUser.uid), {
        display_name: currentUser.displayName || (currentUser.email?.split("@")[0] ?? "Player"),
        mmr: currentProfile?.mmr ?? 0, rank: currentProfile?.rank ?? "Placement",
        pfp_card_id: card.id, pfp_image: card.imageUrl
      }, { merge:true });
      await batch.commit();
      $("#msgPfp").textContent="PFP actualizado y sincronizado con la tabla de jugadores.";
      await loadProfileAndPfp(); renderEdit();
    }catch(e){ $("#msgPfp").textContent=e.message; }
  }
  $("#btnDeletePfp").addEventListener("click", async ()=>{
    try{
      const batch = writeBatch(db), now=new Date().toISOString();
      batch.set(doc(db,"player_profiles", currentUser.uid), { pfp_card_id:null, updated_at:now }, { merge:true });
      batch.set(doc(db,"public_players", currentUser.uid), { pfp_card_id:null, pfp_image:null }, { merge:true });
      await batch.commit(); $("#msgPfp").textContent="PFP eliminado. Se actualizó la tabla de jugadores.";
      await loadProfileAndPfp(); renderEdit();
    }catch(e){ $("#msgPfp").textContent=e.message; }
  });
  $("#btnResend").addEventListener("click", async ()=>{
    try{ await sendEmailVerification(currentUser); $("#msgEditUnv").textContent="Verificación reenviada. Revisa tu correo."; }
    catch(e){ $("#msgEditUnv").textContent=e.message; }
  });
  $("#btnReload").addEventListener("click", async ()=>{
    try{ await reload(currentUser); if(currentUser.emailVerified) render(); else $("#msgEditUnv").textContent="Aún sin verificar. Revisa tu correo."; }
    catch(e){ $("#msgEditUnv").textContent=e.message; }
  });

  /* ====== Lounge / Leaderboard ====== */
  function renderLounge(){
    if(loungeUnsub){ loungeUnsub(); loungeUnsub=null; }
    const tbody=$("#playersTbody");
    tbody.innerHTML = `<tr><td colspan="4" class="help">Cargando…</td></tr>`;

    // Ordenado por MMR desc (live)
    const q = query(collection(db,"public_players"), orderBy("mmr","desc"));
    loungeUnsub = onSnapshot(q, (snap)=>{
      playersCache = [];
      snap.forEach(d=> playersCache.push({ id:d.id, ...d.data() }));
      paintLeaderboard();
    });

    $("#searchName").oninput = paintLeaderboard;
    $("#rankFilter").onchange = paintLeaderboard;
  }

  function paintLeaderboard(){
    const tbody=$("#playersTbody");
    const q = ($("#searchName").value||"").toLowerCase();
    const rf = $("#rankFilter").value;

    let list = playersCache.slice();
    if(q){
      list = list.filter(p => (p.display_name||"").toLowerCase().includes(q));
    }
    if(rf){
      list = list.filter(p => (p.rank||"") === rf);
    }

    if(!list.length){ tbody.innerHTML = `<tr><td colspan="4" class="help">—</td></tr>`; return; }

    tbody.innerHTML = list.map((p,idx)=>{
      const rankClass = "rank-"+(p.rank||"Placement");
      const pfp = p.pfp_image ? `<img src="${p.pfp_image}" alt="pfp">` : "";
      return `<tr>
        <td class="col-num">${idx+1}</td>
        <td><div class="player-cell">${pfp}<span>${escapeHtml(p.display_name||"Player")}</span></div></td>
        <td class="col-mmr">${Number(p.mmr||0)}</td>
        <td class="col-rank"><span class="rank-chip ${rankClass}">${escapeHtml(p.rank||"Placement")}</span></td>
      </tr>`;
    }).join("");
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }

  /* ====== Auth listener ====== */
  onAuthStateChanged(auth, (user)=>{
    currentUser = user || null;
    updateHeader();
    if(location.hash===""||location.hash==="#") location.hash="#/";
    render();
  });

  /* ====== Boot ====== */
  setActiveRoute(); render();
  $$("#route-edit [data-open]").forEach(el=> el.addEventListener("click", ()=> openPanel(el.getAttribute("data-open"))));
</script>
</body>
</html>



