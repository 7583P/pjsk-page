<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PJSK LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#383838; --panel:#2a2a2a; --text:#fff; --muted:#bfbfbf;
      --hover:#595959; --accent:#6c6cf0; --warn:#f0a66c;
      --head:#030050; --row1:#333; --row2:#2a2a2a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    #app{min-height:100%}

    header.topbar{background:var(--panel);border-bottom:1px solid #0006;position:sticky;top:0;z-index:10}
    .nav{max-width:1000px;margin:0 auto;display:flex;gap:14px;align-items:center;padding:12px}
    .nav a{padding:8px 10px;border-radius:8px}
    .nav a.active{background:#444}
    .nav a:hover{background:var(--hover)}
    .grow{flex:1}
    .container{max-width:1000px;margin:20px auto;padding:20px;background:var(--panel);border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.45)}

    .btn{background:#5050ff1f;border:1px solid var(--accent);border-radius:8px;padding:8px 12px;color:#cfd0ff;cursor:pointer}
    .btn:hover{background:#6c6cf02f}
    .btn.ghost{background:transparent;border-color:#777;color:#ddd}
    .btn.warn{border-color:var(--warn);color:#ffd9c0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    .card{background:#1f1f1f;border:1px solid #3a3a3a;border-radius:12px;padding:12px}
    .input{background:#1f1f1f;border:1px solid #555;color:#fff;border-radius:8px;padding:8px 10px;width:100%}
    .help{color:var(--muted);font-size:13px}
    .badge{display:inline-grid;place-items:center;border:1px solid #555;color:#bbb;padding:3px 8px;border-radius:999px;font-size:12px}

    .hero{font-size:30px;margin:0 0 10px;text-align:center}
    .welcome-block{white-space:pre-wrap;background:#1a1a1a;border:1px solid #333;padding:16px;border-radius:12px;font-family:inherit}

    /* PFP */
    .pfp-box{width:220px;height:220px;background:#303030;border:2px dashed #555;border-radius:12px;display:grid;place-items:center;overflow:hidden}
    .pfp-box img{width:100%;height:100%;object-fit:cover}
    .grid.cards{grid-template-columns:repeat(auto-fill,minmax(130px,1fr))}
    .cardbtn{padding:8px;text-align:center;cursor:pointer}
    .cardbtn.selected{outline:2px solid var(--accent);border-radius:10px}

    /* ===== Leaderboard (tu layout) ===== */
    .page-title{font-size:34px;margin:0 0 14px;text-align:center;letter-spacing:.3px}
    .controls{margin-bottom:15px;text-align:center}
    .controls input[type="text"]{
      padding:10px;width:80%;max-width:420px;border:1px solid #555;border-radius:10px;
      background:#1f1f1f;color:#fff;text-align:center
    }

    /* Dropdown de rangos como tu captura */
    .dropdown{position:relative;display:inline-block;margin-left:10px}
    .dropbtn{background:#737373;border:none;color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:bold;white-space:nowrap}
    .dropdown-content{display:none;position:absolute;top:100%;left:0;min-width:220px;background:#595959;box-shadow:0 2px 6px rgba(0,0,0,.2);z-index:10;border-radius:4px;overflow:hidden}
    .dropdown-content a{display:block;padding:8px 12px;color:#fff;text-decoration:none;font-size:14px;white-space:nowrap}
    .dropdown-content a:hover .text-gradient{opacity:.9}

    /* Tabla */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;text-align:center;color:#fff}
    thead th{background:var(--head)}
    tbody td{border-bottom:1px solid #333}
    tbody tr:nth-child(odd){background:var(--row1)}
    tbody tr:nth-child(even){background:var(--row2)}

    /* posición y bandera */
    .position-cell{position:relative;text-align:center;padding-right:32px}
    .position-number{display:inline-block}
    .flag{width:24px;position:absolute;top:50%;right:8px;transform:translateY(-50%)}

    /* Gradientes por rango (para #, nombre, MMR, Rango) */
    .text-gradient,.name-gradient{display:inline-block;background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .rank-Placement{background-image:linear-gradient(to left,#ff7000,#ff4600)}
    .rank-Iron{background-image:linear-gradient(to left,#616161,#2e2e2e)}
    .rank-Bronze{background-image:linear-gradient(to left,#6d2a00,#3d1d00)}
    .rank-Silver{background-image:linear-gradient(to left,#b3b3b3,#696969)}
    .rank-Gold{background-image:linear-gradient(to left,#ffbf60,#c57600)}
    .rank-Platinum{background-image:linear-gradient(to left,#767ec2,#38429f)}
    .rank-Diamond{background-image:linear-gradient(to left,#42a2ff,#003e8f)}
    .rank-Crystal{background-image:linear-gradient(to left,#dca3ff,#883cb4)}
    .rank-Master{background-image:linear-gradient(to left,#c34efd,#5f009e)}
    .rank-Champion{background-image:linear-gradient(to left,#fe6767,#8f0000)}
    .rank-GrandChampion{background-image:linear-gradient(to left,#ff0800,#570300);white-space:nowrap}
    .rank-Legend{background-image:linear-gradient(to left,#c9f4ff,#c9f4ff)}
    .name-gradient .emoji{background:none !important;-webkit-background-clip:initial !important;-webkit-text-fill-color:currentColor !important}

    /* Paginación */
    .pagination{margin-top:15px;display:flex;justify-content:center;align-items:center;gap:8px}
    .pagination button{padding:6px 10px;border:none;border-radius:6px;background:#555;color:#fff;cursor:pointer}
    .pagination button:disabled{opacity:.4;cursor:default}
    .pagination input[type="number"]{width:60px;padding:6px;text-align:center;border-radius:6px;border:1px solid #555;background:#2a2a2a;color:#fff}
  </style>
</head>
<body>
<div id="app">
  <header class="topbar">
    <nav class="nav">
      <a href="#/" data-route>Home</a>
      <a href="#/edit-profile" data-route>Edit Profile</a>
      <a href="#/pjsk-lounge" data-route>PJSK LOUNGE</a>
      <div class="grow"></div>
      <div id="authStatus" class="row"></div>
    </nav>
  </header>

  <main class="container">
    <!-- ===== HOME ===== -->
    <section id="route-home" class="grid" style="gap:18px;display:none">
      <div>
        <h1 class="hero">Welcome to PJSK LOUNGE</h1>
        <div class="welcome-block">
PJSK LOUNGE, new project of competitive pjsk with a DISCORD BOT and PAGE especially created for this project (11/05/25)
How it works?
first of all, the format is 1v1v1v1v1 (2-4 available for now) into a CO-OP with 5 ROUNDS, the amount of perfect,great,good,bad and miss taps will be counted and if u are placement depending on your amount from great to miss taps will determine your starting rank (there are 11 ranks) after the room in discord is full the bot will launch random songs to be selected on HARD/EXPERT/MASTER/APPEND difficulty according to your rank, once the 5 rounds are finished !submit command will be use to update MMR/RANK/ROLES into DISCORD and into the PAGE there are COMMANDS to join a room, leave a room, check top 10, check your mmr (and mmr/rank from other player), check your x season stats/current seasons stats, etc if you are new into the game or you are a top player dosnt matter, any skill is welcome
        </div>
      </div>

      <div class="card">
        <div id="homeButtons" class="row"></div>
        <p id="homeHint" class="help"></p>
      </div>

      <!-- Modales -->
      <div id="panel-register" class="card grid" style="gap:10px;display:none">
        <h3>Register</h3>
        <input class="input" id="regEmail" placeholder="Email" type="email">
        <input class="input" id="regPass" placeholder="Password" type="password">
        <div class="row">
          <button class="btn" id="btnDoRegister">Crear cuenta</button>
          <button class="btn ghost" data-close="panel-register">Cancelar</button>
        </div>
        <p class="help">Recibirás un correo con botón/enlace de verificación.</p>
        <p id="msgRegister" class="help"></p>
      </div>

      <div id="panel-login" class="card grid" style="gap:10px;display:none">
        <h3>Login</h3>
        <input class="input" id="logEmail" placeholder="Email" type="email">
        <input class="input" id="logPass" placeholder="Password" type="password">
        <div class="row">
          <button class="btn" id="btnDoLogin">Entrar</button>
          <button class="btn ghost" data-close="panel-login">Cancelar</button>
        </div>
        <p id="msgLogin" class="help"></p>
      </div>

      <div id="panel-reset" class="card grid" style="gap:10px;display:none">
        <h3>Reset password</h3>
        <input class="input" id="resetEmail" placeholder="Tu correo" type="email">
        <div class="row">
          <button class="btn" id="btnDoReset">Enviar email</button>
          <button class="btn ghost" data-close="panel-reset">Cancelar</button>
        </div>
        <p class="help">Si no existe cuenta, te enviaremos instrucciones para registrarte.</p>
        <p id="msgReset" class="help"></p>
      </div>
    </section>

    <!-- ===== EDIT PROFILE ===== -->
    <section id="route-edit" class="grid" style="gap:18px;display:none">
      <h2>Edit Profile</h2>
      <div id="edit-loading">Cargando…</div>

      <!-- No autenticado -->
      <div id="edit-guest" class="card grid" style="gap:10px;display:none">
        <p class="help">No has iniciado sesión.</p>
        <div class="row">
          <button class="btn" data-open="panel-register">Register</button>
          <button class="btn ghost" data-open="panel-login">Login</button>
          <button class="btn ghost" data-open="panel-reset">Reset password</button>
        </div>
      </div>

      <!-- Autenticado, no verificado -->
      <div id="edit-unverified" class="card grid" style="gap:10px;display:none">
        <p><strong>Verifica tu correo para continuar</strong></p>
        <p class="help">Te hemos enviado un email con un botón/enlace de verificación.</p>
        <div class="row">
          <button class="btn" id="btnResend">Resend verification</button>
          <button class="btn ghost" id="btnReload">Refrescar estado</button>
        </div>
        <p id="msgEditUnv" class="help"></p>
      </div>

      <!-- Autenticado y verificado -->
      <div id="edit-verified" class="grid" style="gap:14px;display:none">
        <div class="card grid" style="gap:10px">
          <label>Name (read-only)</label>
          <input class="input" id="displayNameRO" readonly />
        </div>

        <div class="grid" style="gap:14px">
          <h3>set pfp in game cards</h3>
          <div class="row" style="align-items:flex-start">
            <div class="pfp-box" id="pfpBox"><span class="help">(sin PFP)</span></div>
            <div class="card" style="flex:1">
              <div id="cardsGrid" class="grid cards"></div>
              <div class="row" style="margin-top:10px">
                <button class="btn warn" id="btnDeletePfp">Delete pfp</button>
              </div>
              <p id="msgPfp" class="help"></p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== PJSK LOUNGE (Leaderboard — Vue) ===== -->
    <section id="route-lounge" style="display:none">
      <div id="loungeApp">
        <h2 class="page-title">PJSK LOUNGE — Season {{ seasonLabel }}</h2>

        <div class="controls">
          <input type="text" v-model="filter" placeholder="Buscar por nombre…" v-if="!selectedRank">

          <!-- ▼ Mini pestaña desplegable de Rangos (igual a tu UI) -->
          <div class="dropdown">
            <button class="dropbtn" @click.stop="toggleRanks">
              <template v-if="selectedRank">
                <span :class="['text-gradient','rank-'+selectedRank]">Filtrar por {{ displayRank(selectedRank) }}</span>
                <span :class="['text-gradient','rank-'+selectedRank]">({{ filteredCount }}) ▾</span>
              </template>
              <template v-else>
                <span class="text-gradient rank-Legend">Rangos ▾</span>
              </template>
            </button>

            <div class="dropdown-content" v-show="showRanks" id="rankList">
              <!-- Solo rangos (sin 'All Ranges' aquí, tal como tu código) -->
              <a v-for="r in ranks" :key="r.key" href="#" @click.prevent="selectRank(r.key)">
                <span :class="['text-gradient','rank-'+r.key]">{{ r.label }} ({{ r.range }})</span>
              </a>
            </div>
          </div>
          <!-- ▲ Fin mini pestaña -->

          <button v-if="selectedRank"
                  @click="clearRank"
                  style="margin-left:10px;background:#555;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">
            Mostrar todos ▾
          </button>
        </div>

        <div class="card">
          <table>
            <thead>
              <tr><th>#</th><th>Player</th><th>MMR</th><th>Rango</th></tr>
            </thead>
            <tbody>
              <tr v-if="loading"><td colspan="4" class="help">Cargando...</td></tr>
              <tr v-else-if="errorMsg"><td colspan="4" class="help">{{ errorMsg }}</td></tr>
              <tr v-else-if="!paginatedPlayers.length"><td colspan="4" class="help">—</td></tr>

              <tr v-for="p in paginatedPlayers" :key="p.id">
                <td class="position-cell">
                  <span :class="['position-number','text-gradient','rank-'+p.rank]">{{ playerRankMap[p.id] }}</span>
                  <img v-if="p.country" :src="flagUrl(p.country)" :alt="p.country" class="flag" />
                </td>
                <td>
                  <span :class="['name-gradient','rank-'+p.rank]">
                    <template v-for="(seg, idx) in splitName(p.name)" :key="idx">
                      <span v-if="seg.isEmoji" class="emoji">{{ seg.char }}</span>
                      <span v-else>{{ seg.char }}</span>
                    </template>
                  </span>
                </td>
                <td><span :class="['text-gradient','rank-'+p.rank]">{{ p.mmr }}</span></td>
                <td><span :class="['text-gradient','rank-'+p.rank]">{{ displayRank(p.rank) }}</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination">
          <button @click="prevPage" :disabled="currentPage<=1">&laquo;</button>
          <input type="number" v-model.number="currentPage" :min="1" :max="totalPages" />
          <span>/ {{ totalPages }}</span>
          <button @click="nextPage" :disabled="currentPage>=totalPages">&raquo;</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Firebase SDK (auth + firestore) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification,
    sendPasswordResetEmail, signOut, updateProfile, reload
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  /* === TU CONFIG FIREBASE === */
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await setPersistence(auth, browserLocalPersistence);

  /* Utils + router */
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
  function setActiveRoute(){ const h=location.hash||"#/"; $$('a[data-route]').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===h)); }
  function showRoute(el){ $("#route-home").style.display="none"; $("#route-edit").style.display="none"; $("#route-lounge").style.display="none"; el&&(el.style.display=""); setActiveRoute(); }
  function render(){ const h=location.hash||"#/"; if(h.startsWith("#/edit-profile")){ showRoute($("#route-edit")); renderEdit(); } else if(h.startsWith("#/pjsk-lounge")){ showRoute($("#route-lounge")); } else { showRoute($("#route-home")); renderHome(); } }
  window.addEventListener("hashchange", render);

  /* Header */
  let currentUser=null, currentProfile=null;
  function updateHeader(){
    const box=$("#authStatus"); box.innerHTML="";
    if(currentUser){
      const badge=document.createElement("span"); badge.className="badge"; badge.textContent=currentUser.email;
      const btn=document.createElement("button"); btn.className="btn ghost"; btn.textContent="Log out";
      btn.onclick=async()=>{ await signOut(auth); location.hash="#/"; };
      box.append(badge,btn);
    }else{
      const a1=document.createElement("a"); a1.className="btn ghost"; a1.href="#/"; a1.textContent="Register";
      const a2=document.createElement("a"); a2.className="btn"; a2.href="#/"; a2.textContent="Login";
      box.append(a1,a2);
    }
  }

  /* Home (register/login/reset) */
  function renderHome(){
    const hb=$("#homeButtons"), hint=$("#homeHint");
    $("#panel-register").style.display="none"; $("#panel-login").style.display="none"; $("#panel-reset").style.display="none";
    $("#msgRegister").textContent=""; $("#msgLogin").textContent=""; $("#msgReset").textContent="";
    hb.innerHTML="";
    if(!currentUser){
      hb.append(btn("Register",()=>open("panel-register")), btn("Login",()=>open("panel-login"),"ghost"), btn("Reset password",()=>open("panel-reset"),"ghost"));
      hint.textContent="También puedes usar Edit Profile para acceder a Register/Login/Reset.";
    }else{
      hb.append(btn("Log out", async()=>{ await signOut(auth); },"warn")); hint.textContent="Sigue en Edit Profile para configurar tu PFP.";
    }
  }
  function btn(t,fn,v=""){ const b=document.createElement("button"); b.className="btn"+(v?` ${v}`:""); b.textContent=t; b.onclick=fn; return b; }
  function open(id){ $("#"+id).style.display=""; }
  $$("#route-home [data-close]").forEach(el=> el.addEventListener("click", ()=> $("#"+el.getAttribute("data-close")).style.display="none"));

  $("#btnDoRegister").addEventListener("click", async ()=>{
    const email=$("#regEmail").value.trim(), pass=$("#regPass").value; $("#msgRegister").textContent="";
    try{
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      const displayName=email.split("@")[0]; await updateProfile(cred.user,{displayName}); await sendEmailVerification(cred.user);
      const batch=writeBatch(db), now=new Date().toISOString();
      batch.set(doc(db,"player_profiles", cred.user.uid), {user_id:cred.user.uid,pfp_card_id:null,mmr:0,rank:"Placement",updated_at:now});
      batch.set(doc(db,"public_players", cred.user.uid), {display_name:displayName,mmr:0,rank:"Placement",pfp_card_id:null,pfp_image:null});
      await batch.commit();
      $("#msgRegister").textContent="Cuenta creada. Revisa tu correo para verificar tu cuenta."; $("#panel-register").style.display="none";
    }catch(e){ $("#msgRegister").textContent=e.message; }
  });

  $("#btnDoLogin").addEventListener("click", async ()=>{
    const email=$("#logEmail").value.trim(), pass=$("#logPass").value; $("#msgLogin").textContent="";
    try{
      const { user } = await signInWithEmailAndPassword(auth,email,pass);
      if(!user.emailVerified){ $("#msgLogin").textContent="Tu correo no está verificado. Usa 'Resend verification' en Edit Profile."; }
      else { $("#msgLogin").textContent="Login correcto."; $("#panel-login").style.display="none"; location.hash="#/edit-profile"; }
    }catch(e){ $("#msgLogin").textContent=e.message; }
  });

  $("#btnDoReset").addEventListener("click", async ()=>{
    const email=$("#resetEmail").value.trim(); $("#msgReset").textContent="";
    try{ await sendPasswordResetEmail(auth,email); $("#msgReset").textContent="Si existe una cuenta, te enviamos instrucciones. Si no, te guiaremos a registrarte."; $("#panel-reset").style.display="none"; }
    catch(e){ $("#msgReset").textContent=e.message; }
  });

  /* Edit Profile */
  async function renderEdit(){
    $("#edit-loading").style.display=""; $("#edit-guest").style.display="none"; $("#edit-unverified").style.display="none"; $("#edit-verified").style.display="none";
    $("#msgPfp").textContent=""; $("#msgEditUnv").textContent="";
    if(!currentUser){ $("#edit-loading").style.display="none"; $("#edit-guest").style.display=""; return; }
    await reload(currentUser); const verified=!!currentUser.emailVerified; $("#edit-loading").style.display="none";
    if(!verified){ $("#edit-unverified").style.display=""; return; }
    $("#edit-verified").style.display=""; $("#displayNameRO").value=currentUser.displayName || (currentUser.email?.split("@")[0] ?? "Player");
    await loadProfileAndPfp(); drawCards();
  }
  async function loadProfileAndPfp(){
    const snap = await getDoc(doc(db,"player_profiles", currentUser.uid));
    currentProfile = snap.exists()? snap.data(): null;
    const box=$("#pfpBox"); box.innerHTML="";
    if(currentProfile?.pfp_card_id){ box.innerHTML='<span class="help">(pfp seleccionado)</span>'; } else { box.innerHTML='<span class="help">(sin PFP)</span>'; }
  }
  function drawCards(){
    const CARDS=[{id:"c1",name:"Miku — Sky Blue",imageUrl:""}, {id:"c2",name:"Miku — Neon Heart",imageUrl:""}]; // mock visible
    const grid=$("#cardsGrid"); grid.innerHTML="";
    CARDS.forEach(c=>{ const b=document.createElement("button"); b.className="card cardbtn"; b.innerHTML=`<div style="height:150px;border-radius:8px;background:#222;display:grid;place-items:center">${c.name}</div>`; if(currentProfile?.pfp_card_id===c.id) b.classList.add("selected"); b.onclick=()=>setPfp(c); grid.appendChild(b); });
  }
  async function setPfp(card){
    try{
      const batch=writeBatch(db), now=new Date().toISOString();
      batch.set(doc(db,"player_profiles", currentUser.uid), {user_id:currentUser.uid,pfp_card_id:card.id,mmr:currentProfile?.mmr??0,rank:currentProfile?.rank??"Placement",updated_at:now},{merge:true});
      batch.set(doc(db,"public_players", currentUser.uid), {display_name: currentUser.displayName || (currentUser.email?.split("@")[0] ?? "Player"), mmr:currentProfile?.mmr??0, rank:currentProfile?.rank??"Placement", pfp_card_id:card.id, pfp_image:null},{merge:true});
      await batch.commit(); $("#msgPfp").textContent="PFP actualizado."; await loadProfileAndPfp(); drawCards();
    }catch(e){ $("#msgPfp").textContent=e.message; }
  }
  $("#btnDeletePfp").addEventListener("click", async ()=>{
    try{
      const batch=writeBatch(db), now=new Date().toISOString();
      batch.set(doc(db,"player_profiles", currentUser.uid), {pfp_card_id:null,updated_at:now},{merge:true});
      batch.set(doc(db,"public_players", currentUser.uid), {pfp_card_id:null,pfp_image:null},{merge:true});
      await batch.commit(); $("#msgPfp").textContent="PFP eliminado."; await loadProfileAndPfp(); drawCards();
    }catch(e){ $("#msgPfp").textContent=e.message; }
  });
  $("#btnResend").addEventListener("click", async ()=>{ try{ await sendEmailVerification(currentUser); $("#msgEditUnv").textContent="Verificación reenviada."; }catch(e){ $("#msgEditUnv").textContent=e.message; } });
  $("#btnReload").addEventListener("click", async ()=>{ try{ await reload(currentUser); if(currentUser.emailVerified) render(); else $("#msgEditUnv").textContent="Aún sin verificar."; }catch(e){ $("#msgEditUnv").textContent=e.message; } });

  /* Auth state */
  onAuthStateChanged(auth,(u)=>{ currentUser=u||null; updateHeader(); if(location.hash===""||location.hash==="#") location.hash="#/"; render(); });
  setActiveRoute(); render();
  $$("#route-edit [data-open]").forEach(el=> el.addEventListener("click", ()=> open(el.getAttribute("data-open"))));
</script>

<!-- Vue + Axios SOLO para el leaderboard -->
<script src="https://unpkg.com/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const { createApp } = Vue;

  // Normaliza filas para tolerar cambios de nombres de campo
  function normalizeRow(row, i){
    return {
      id: row.id || row.uid || row.userId || row._id || String(i),
      name: row.name || row.display_name || row.player || row.Player || 'Player',
      mmr: Number(row.mmr ?? row.MMR ?? row.rating ?? 0),
      rank: row.rank || row.Rango || row.tier || 'Placement',
      country: row.country || row.flag || row.cc || row.Country || null
    };
  }

  const loungeApp = createApp({
    data(){ return {
      loading:true,
      errorMsg:'',
      players:[],
      filter:'',
      selectedRank:null,
      showRanks:false,
      playerRankMap:{},
      currentPage:1,
      pageSize:50,
      // misma lista y orden que tu código + etiquetas de rango MMR
      ranks:[
        { key:'Iron',           label:'Iron',           range:'0-100'   },
        { key:'Bronze',         label:'Bronze',         range:'101-200' },
        { key:'Silver',         label:'Silver',         range:'201-300' },
        { key:'Gold',           label:'Gold',           range:'301-400' },
        { key:'Platinum',       label:'Platinum',       range:'401-500' },
        { key:'Diamond',        label:'Diamond',        range:'501-600' },
        { key:'Crystal',        label:'Crystal',        range:'601-700' },
        { key:'Master',         label:'Master',         range:'701-800' },
        { key:'Champion',       label:'Champion',       range:'801-900' },
        { key:'GrandChampion',  label:'Grand Champion', range:'901-999' },
        { key:'Legend',         label:'Legend',         range:'+1000'   }
      ]
    }},
    computed:{
      filteredPlayers(){
        let list=this.players;
        if (this.selectedRank) {
          list = list.filter(p => p.rank === this.selectedRank);
        } else if (this.filter) {
          list = list.filter(p => (p.name||'').toLowerCase().includes(this.filter.toLowerCase()));
        }
        return list;
      },
      filteredCount(){ return this.players.filter(p => p.rank === this.selectedRank).length; },
      totalPages(){ return Math.max(1, Math.ceil(this.filteredPlayers.length / this.pageSize)); },
      paginatedPlayers(){
        const start=(this.currentPage-1)*this.pageSize;
        return this.filteredPlayers.slice(start, start+this.pageSize);
      },
      seasonLabel(){ return 'Beta'; }
    },
    watch:{
      filter(){ this.currentPage=1; },
      selectedRank(){ this.currentPage=1; this.filter=''; }
    },
    methods:{
      toggleRanks(){ this.showRanks=!this.showRanks; },
      selectRank(r){ this.selectedRank=r; this.showRanks=false; },
      clearRank(){ this.selectedRank=null; this.showRanks=false; },
      prevPage(){ if(this.currentPage>1) this.currentPage--; },
      nextPage(){ if(this.currentPage<this.totalPages) this.currentPage++; },

      async fetchPlayers(){
        this.loading = true; this.errorMsg='';
        try{
          const url = 'https://worker-production-1ad2.up.railway.app/api/players';

          let data;
          try {
            const resp = await axios.get(url, { withCredentials:false });
            data = resp.data;
          } catch (axErr) {
            // Fallback por si axios choca con CORS en ciertos hostings
            const r = await fetch(url, { mode:'cors', credentials:'omit' });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            data = await r.json();
          }

          if (!Array.isArray(data)) throw new Error('Respuesta no es un array');

          const normalized = data.map((row,i)=> normalizeRow(row,i));
          const sorted = normalized.sort((a,b)=> (b.mmr||0) - (a.mmr||0));
          const map={}; sorted.forEach((p,i)=> map[p.id]=i+1);

          this.players = sorted;
          this.playerRankMap = map;
        }catch(e){
          console.error(e);
          this.players=[]; this.playerRankMap={};
          this.errorMsg = (e && e.message) ? `Error al cargar datos: ${e.message}` : 'Error al cargar datos';
        }finally{
          this.loading=false;
        }
      },

      flagUrl(cc){ return `https://flagcdn.com/24x18/${String(cc||'').toLowerCase()}.png`; },
      displayRank(r){ return r==='GrandChampion' ? 'Grand Champion' : r; },
      splitName(name){
        const emojiPres=/\p{Emoji_Presentation}/u;
        return Array.from(String(name||'')).map(c=>({char:c,isEmoji:emojiPres.test(c)}));
      }
    },
    mounted(){
      this.fetchPlayers();
      // Auto refresh cada 10s
      this._timer=setInterval(this.fetchPlayers, 10000);
      // Cierra el menú al hacer click fuera
      document.addEventListener('click', ()=>{ if(this.showRanks) this.showRanks=false; });
    },
    beforeUnmount(){ clearInterval(this._timer); }
  });

  loungeApp.mount('#loungeApp');
</script>
</body>
</html>


