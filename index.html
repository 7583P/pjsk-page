<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PJSK LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#1e1e1e; --panel:#22252b; --panel2:#1b1e23; --ink:#fff; --muted:#bfc5d0;
      --brand:#6c6cf0; --warn:#f0a66c; --ok:#58d68d; --err:#ff6b6b; --line:#0006;
      --hover:#2f3541; --chip:#2a2f3a; --rowhLB:56px;
      --menu:#2a2f38; --menuBorder:#0008;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, rgba(108,108,240,.08), transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, rgba(240,166,108,.08), transparent 60%),
      var(--bg);
      color:var(--ink);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    a{color:inherit;text-decoration:none}
    #app{min-height:100%}

    /* Topbar */
    header.topbar{background:var(--panel);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:20}
    .topbar-row{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:8px;height:8px;border-radius:50%;background:#7d7dff;box-shadow:0 0 8px #7d7dff}
    nav.tabs{margin-left:auto;display:flex;gap:8px}
    .tab{padding:8px 14px;border-radius:10px;color:#cfd4df}
    .tab.active{background:#6c6cf016;border:1px solid #6c6cf033;color:#fff}
    .tab:hover{background:var(--hover)}

    /* Hero */
    .hero{max-width:1200px;margin:20px auto 0;padding:28px;background:linear-gradient(180deg,#2a2f3a,#1f232b);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 28px rgba(0,0,0,.35) inset}
    .hero h1{font-size:48px;line-height:1.1;margin:0 0 10px}
    .hero p{margin:0;color:#cbd1dc}

    /* Grid two cards */
    .grid-2{max-width:1200px;margin:18px auto;padding:0 6px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.25)}
    .card .wrap{padding:18px}
    .card h3{margin:0 0 8px}
    .in{width:100%;padding:12px 12px;border-radius:10px;background:#0f1217;border:1px solid #0b0e13;color:#e9edf6;outline:none}
    .in::placeholder{color:#7a8496}
    .row{display:flex;gap:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;border:1px solid #0008;background:#6c6cf0;color:#fff;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.ghost{background:#3b3f4b;border-color:#000a}
    .btn.neutral{background:#505668}
    .btn.warn{background:#f0a66c}
    .btn.ok{background:#58d68d}
    .btn.err{background:#ff6b6b}
    .btn.block{width:100%}
    .hint{color:#bfc5d0;font-size:12px}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .errbox{background:#3a1616;border:1px solid #5b1c1c;color:#ffb3b3;border-radius:10px;padding:10px 12px}
    .okbox{background:#173822;border:1px solid #1f5b3a;color:#a7ffd2;border-radius:10px;padding:10px 12px}
    .center{display:flex;align-items:center;justify-content:center}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Profile gate */
    .gate{max-width:900px;margin:18px auto;padding:18px;background:var(--panel);border:1px solid var(--line);border-radius:12px}
    .gate h3{margin:0 0 8px}
    .gate .row{align-items:center}
    .msg{padding:10px 12px;border-radius:10px;background:#2a2f3a;border:1px solid #1b1e23;color:#cbd1dc}

    /* Profile layout */
    .profile-card{max-width:900px;margin:18px auto;background:var(--panel);border:1px solid var(--line);border-radius:12px}
    .profile-card .wrap{padding:18px}
    .profile-row{display:flex;gap:16px;align-items:center}
    .flag{width:36px;height:24px;background:#333;border-radius:4px}
    .pfp{width:64px;height:64px;border-radius:8px;background:#0003;display:none;object-fit:cover;border:1px solid #0008}
    .pfp.show{display:block}

    /* Leaderboard */
    .toolbar{max-width:1200px;margin:8px auto 0;padding:0 6px;display:flex;gap:10px;align-items:center}
    .dropdown{position:relative}
    .drop-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--menuBorder);background:var(--menu);cursor:pointer}
    .menu{position:absolute;top:calc(100% + 6px);left:0;min-width:280px;background:#232833;border:1px solid var(--menuBorder);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.45);padding:6px;display:none;z-index:9}
    .menu.open{display:block}
    .menu .item{display:flex;justify-content:space-between;gap:8px;padding:10px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .menu .item:hover{background:#2e3442;border-color:#0008}
    .menu small{color:#9aa3b4}
    .count-badge{background:#0f1217;border:1px solid #0b0e13;border-radius:999px;padding:2px 8px;color:#cbd1dc;min-width:28px;text-align:center}

    /* gradient text for ranks */
    .grad{background-clip:text;-webkit-background-clip:text;color:transparent;-webkit-text-fill-color:transparent}
    .rank-Placement   { background-image: linear-gradient(to left, #ff7000, #ff4600); }
    .rank-Iron        { background-image: linear-gradient(to left, #616161, #2e2e2e); }
    .rank-Bronze      { background-image: linear-gradient(to left, #6d2a00, #3d1d00); }
    .rank-Silver      { background-image: linear-gradient(to left, #b3b3b3, #696969); }
    .rank-Gold        { background-image: linear-gradient(to left, #ffbf60, #c57600); }
    .rank-Platinum    { background-image: linear-gradient(to left, #767ec2, #38429f); }
    .rank-Diamond     { background-image: linear-gradient(to left, #42a2ff, #003e8f); }
    .rank-Crystal     { background-image: linear-gradient(to left, #dca3ff, #883cb4); }
    .rank-Master      { background-image: linear-gradient(to left, #c34efd, #5f009e); }
    .rank-Champion    { background-image: linear-gradient(to left, #fe6767, #8f0000); }
    .rank-GrandChampion { background-image: linear-gradient(to left, #ff0800, #570300); white-space: nowrap; }
    .rank-Legend      { background-image: linear-gradient(to left, #c9f4ff, #c9f4ff); }

    /* Table */
    .lb{max-width:1200px;margin:10px auto 28px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--panel)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;text-align:left}
    thead{background:#171a20}
    tr+tr{border-top:1px solid #3a3f4a} /* solo líneas horizontales */
    td.flagCell{width:70px}
    .cell{display:flex;align-items:center;gap:10px}
    .avatar{width:36px;height:36px;border-radius:6px;object-fit:cover;display:block}
    .hide{display:none !important}

    /* Modal */
    dialog{border:none;border-radius:14px;padding:0;max-width:1000px;width:90%;background:var(--panel);color:var(--ink)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .dlg-head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between}
    .dlg-body{padding:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(120px,1fr));gap:10px}
    .card-tile{background:#0f1217;border:1px solid #0b0e13;border-radius:10px;overflow:hidden;cursor:pointer}
    .card-tile img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
    .card-tile div{padding:6px 8px;font-size:12px;color:#cbd1dc}
    .x{background:#0000;border:none;color:#cbd1dc;font-size:20px;cursor:pointer;padding:6px 10px;border-radius:10px}
    .x:hover{background:#2f3541}
  </style>
</head>
<body>
<div id="app">
  <header class="topbar">
    <div class="topbar-row">
      <div class="brand"><span class="dot"></span> PJSK LOUNGE</div>
      <nav class="tabs">
        <a class="tab active" data-route="home">Home</a>
        <a class="tab" data-route="leaderboard">Leaderboard</a>
        <a class="tab" data-route="profile">Edit Profile</a>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero">
    <h1>Welcome to PJSK LOUNGE</h1>
    <p>PJSK competitive — Discord Bot + Page.</p>
  </section>

  <!-- HOME -->
  <section id="view-home" class="view active">
    <div class="grid-2">

      <!-- Login -->
      <div class="card">
        <div class="wrap">
          <h3>Log in</h3>
          <label class="hint">Discord username o Showname</label>
          <input id="login-username" class="in mt8" placeholder="usuario123 o usuario#0001">
          <label class="hint mt12">Email</label>
          <input id="login-email" class="in mt8" placeholder="usuario123@email.com" type="email" autocomplete="email">
          <label class="hint mt12">Contraseña</label>
          <input id="login-pass" class="in mt8" type="password" autocomplete="current-password">

          <button id="btn-login" class="btn block mt16">Entrar</button>

          <div class="row mt12">
            <button class="btn ghost" id="btn-login-discord">Conectar con Discord</button>
            <button class="btn neutral" id="btn-reset">Reset password</button>
          </div>
          <div id="login-msg" class="hint mt12"></div>
        </div>
      </div>

      <!-- Register -->
      <div class="card">
        <div class="wrap">
          <h3>Register</h3>
          <label class="hint">Discord username o Showname</label>
          <input id="reg-username" class="in mt8" placeholder="perumatias">
          <label class="hint mt12">Email</label>
          <input id="reg-email" class="in mt8" type="email" placeholder="tu@email.com" autocomplete="email">
          <label class="hint mt12">Contraseña</label>
          <input id="reg-pass" class="in mt8" type="password" autocomplete="new-password">

          <button id="btn-register" class="btn block mt16">Crear cuenta</button>

          <div class="row mt12">
            <button class="btn ghost" id="btn-reg-discord">Conectar con Discord</button>
            <button class="btn neutral" id="btn-resend-verify">Reenviar verificación email</button>
          </div>
          <div id="reg-msg" class="hint mt12"></div>
          <div id="reg-error" class="errbox mt12 hide"></div>
          <div id="reg-ok" class="okbox mt12 hide"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="view-leaderboard" class="view">
    <div class="toolbar">
      <div class="dropdown" id="rankDropdown">
        <button class="drop-btn" id="rankBtn">Rangos (Todos)</button>
        <div class="menu" id="rankMenu">
          <!-- items via JS -->
        </div>
      </div>
      <button id="btn-show-all" class="btn ghost hide">Mostrar todo</button>
    </div>

    <div class="lb">
      <table id="lb-table">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th class="flagCell">Bandera</th>
            <th>Usuario</th>
            <th>Rango</th>
            <th>MMR</th>
          </tr>
        </thead>
        <tbody id="lb-body">
          <!-- rows via JS -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="view-profile" class="view">
    <div id="gate" class="gate">
      <h3>Edit Profile</h3>
      <div id="gate-content" class="msg">You must be registered/loged in.</div>
    </div>

    <div id="profile-card" class="profile-card hide">
      <div class="wrap">
        <div class="profile-row">
          <div class="flag" id="flagBox" title="Bandera (opcional)"></div>
          <img id="pfpImg" class="pfp" alt="pfp">
          <div>
            <div id="prof-name" style="font-weight:700;font-size:18px">—</div>
            <div id="prof-sub" class="hint">Discord: —</div>
          </div>
        </div>

        <div class="row mt16">
          <button class="btn" id="btn-set-pfp">Set PFP</button>
          <button class="btn ghost" id="btn-remove-pfp">Eliminar PFP</button>
        </div>
        <div id="profile-msg" class="hint mt12"></div>
      </div>
    </div>
  </section>
</div>

<!-- PFP PICKER -->
<dialog id="pfpDialog">
  <div class="dlg-head">
    <div class="row" style="align-items:center">
      <strong>Elegir carta (entrenada / no entrenada)</strong>
    </div>
    <button class="x" id="dlgClose">✕</button>
  </div>
  <div class="dlg-body">
    <div class="row">
      <input id="cardSearch" class="in" placeholder="Busca por personaje / nombre / id…">
      <button id="reloadCards" class="btn ghost">Recargar</button>
    </div>
    <div class="hint mt8">Si el catálogo remoto falla por CORS, coloca un <code>cards.json</code> junto al HTML.</div>
    <div id="cardsGrid" class="grid mt12"></div>
  </div>
</dialog>

<script type="module">
  /*************** Firebase (modular SDK v10) ***************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword,
    updateProfile, sendEmailVerification, sendPasswordResetEmail, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ======= REEMPLAZA ESTO CON TU CONFIG REAL =======
  const firebaseConfig = {
    // TODO: your firebaseConfig here (apiKey, authDomain, projectId, appId, etc.)
  };
  // ================================================

  // Protección: si no hay apiKey => evita crash y muestra error visible
  if (!firebaseConfig.apiKey) {
    document.getElementById('reg-error').classList.remove('hide');
    document.getElementById('reg-error').textContent =
      "Error al registrar: Firebase: Error (auth/api-key-not-valid.-please-pass-a-valid-api-key.). " +
      "Ve a Project settings → Web App y pega tu firebaseConfig real. Agrega tu dominio en Authorized domains.";
  }

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /*************** Estado global sencillo ***************/
  const state = {
    user: null,                 // auth user
    userDoc: null,              // Firestore user doc
    verificationDeadlineMs: 0,  // 5 min desde último envío
    selectedRank: null,         // filtro LB
    MOCK_DISCORD: false,        // true para probar sin backend
  };

  // Rango → intervalos
  const RANKS = [
    ["Iron", 0, 100],
    ["Bronze", 101, 200],
    ["Silver", 201, 300],
    ["Gold", 301, 400],
    ["Platinum", 401, 500],
    ["Diamond", 501, 600],
    ["Crystal", 601, 700],
    ["Master", 701, 800],
    ["Champion", 801, 900],
    ["GrandChampion", 901, 999],
    ["Legend", 1000, Infinity],
  ];
  const rankClass = (name)=>`rank-${name}`; // para gradiente

  // Leaderboard demo data (usa tu backend/Firestore en producción)
  let players = [
    { name:"alice",  mmr:132, rank:"Bronze",  country:"pe", pfp:null },
    { name:"bob",    mmr:518, rank:"Diamond", country:"us", pfp:null },
    { name:"carol",  mmr:298, rank:"Silver",  country:"jp", pfp:null },
    { name:"diego",  mmr:845, rank:"Champion",country:"pe", pfp:null },
    { name:"matias", mmr:1001,rank:"Legend",  country:"pe", pfp:null },
  ];

  /*************** Utilidades ***************/
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>document.querySelectorAll(sel);
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  function getRankNameByMMR(mmr) {
    for (const [name, lo, hi] of RANKS) {
      if (mmr>=lo && mmr<=hi) return name;
    }
    return "Placement";
  }
  function formatRankItem([name, lo, hi]) {
    const range = name==="Legend" ? "↑1000" : (name==="Iron" ? "↓0-100" : `${lo}-${hi}`);
    return {name, label:`${name} (${range})`};
  }

  function requireAuthToast() {
    const cont = $("#gate-content");
    cont.innerHTML = 'You must be registered/loged in.';
  }

  function setGate(message, extraHtml="") {
    const cont = $("#gate-content");
    cont.innerHTML = `<div class="msg">${message}${extraHtml?("<br>"+extraHtml):""}</div>`;
  }

  function showProfileCard(show) {
    $("#profile-card").classList.toggle("hide", !show);
  }

  function secsLeft(deadlineMs) {
    const now = Date.now();
    return Math.max(0, Math.floor((deadlineMs-now)/1000));
    }

  function startVerifyCountdown(deadlineMs, outletEl, prefix="Verifica tu email. Expira en") {
    const tick = ()=>{
      const s = secsLeft(deadlineMs);
      if (s<=0) {
        outletEl.textContent = "Tiempo de verificación vencido. Reenvía el correo para continuar.";
        return;
      }
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      outletEl.textContent = `${prefix} ${mm}:${ss}`;
      requestAnimationFrame(()=>setTimeout(tick, 250));
    };
    tick();
  }

  /** guarda/actualiza user doc */
  async function upsertUserDoc(uid, patch) {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      await updateDoc(ref, patch);
    } else {
      await setDoc(ref, { createdAt: Date.now(), ...patch });
    }
  }

  /** bloquea features si no hay Discord o verificación (5m UI gate) */
  function refreshProfileGate() {
    if (!state.user) { requireAuthToast(); showProfileCard(false); return; }

    const emailVerified = !!state.user.emailVerified;
    const doc = state.userDoc || {};
    const discordLinked = !!doc.discordLinked;
    const expected = doc.expectedUsername || "(sin username)";

    if (!emailVerified) {
      showProfileCard(false);
      const s = secsLeft(state.verificationDeadlineMs);
      const countdown = s>0
        ? `<br><br><strong>Te enviamos un correo de verificación.</strong> Tienes 5 minutos para verificar. <em>Tiempo restante</em>: ${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}.`
        : `<br><br>Tu email aún no está verificado. Reenvía el correo y verifica para continuar.`;
      setGate(`Tu cuenta no está verificada.`, countdown);
      return;
    }

    if (!discordLinked) {
      showProfileCard(false);
      setGate(`Tu cuenta debe estar vinculada con Discord y el username debe coincidir.`,
        `<br><button class="btn" id="gate-link-discord">Vincular con Discord</button>`);
      // attach handler
      setTimeout(()=>{ const b=$("#gate-link-discord"); b && (b.onclick=connectDiscord); }, 0);
      return;
    }

    // ok: mostrar profile
    showProfileCard(true);
    $("#prof-name").textContent = state.user.displayName || "(sin nombre)";
    $("#prof-sub").textContent = `Discord: ${doc.discordUsername || "—"} ✓  •  Email verificado ✓`;
    const pfp = doc.pfpUrl || null;
    const img = $("#pfpImg");
    if (pfp) { img.src = pfp; img.classList.add("show"); }
    else { img.removeAttribute("src"); img.classList.remove("show"); }
    setGate(`Perfil habilitado.`, "");
  }

  /** ======= Auth listeners ======= */
  onAuthStateChanged(auth, async (u)=>{
    state.user = u || null;
    if (!u) {
      state.userDoc = null;
      requireAuthToast();
      showProfileCard(false);
      $("#login-msg").textContent = "";
      $("#reg-msg").textContent = "";
      return;
    }
    // user doc live
    const ref = doc(db, "users", u.uid);
    onSnapshot(ref, (snap)=>{
      state.userDoc = snap.exists() ? snap.data() : null;
      refreshProfileGate();
    });

    // set verification deadline (UI gate)
    const deadline = (await getDoc(ref)).exists() ? (await getDoc(ref)).data().verificationDeadlineMs : 0;
    state.verificationDeadlineMs = deadline || 0;

    // actualizar hero info opcional
    refreshProfileGate();
  });

  /*************** Navegación ***************/
  const routes = ["home","leaderboard","profile"];
  function show(route) {
    routes.forEach(r=>{
      document.getElementById(`view-${r}`).classList.toggle("active", r===route);
      $$(`.tab`).forEach(t=>t.classList.toggle("active", t.dataset.route===route));
    });
  }
  $$(".tab").forEach(t=>t.addEventListener("click", ()=>show(t.dataset.route)));

  /*************** Register ***************/
  $("#btn-register").onclick = async ()=>{
    const username = $("#reg-username").value.trim();
    const email = $("#reg-email").value.trim();
    const pass = $("#reg-pass").value;

    $("#reg-error").classList.add("hide"); $("#reg-ok").classList.add("hide");

    if (!username || !email || !pass) {
      $("#reg-error").classList.remove("hide");
      $("#reg-error").textContent = "Completa username, email y contraseña.";
      return;
    }
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: username });

      // crear user doc base
      await upsertUserDoc(cred.user.uid, {
        expectedUsername: username,
        discordLinked: false,
        discordUsername: null,
        pfpUrl: null,
      });

      // Enviar verificación y comenzar gate de 5 min (UI)
      await sendEmailVerification(cred.user, {
        url: window.location.origin + "/",
        handleCodeInApp: false
      });
      const deadlineMs = Date.now() + 5*60*1000; // 5 minutos
      state.verificationDeadlineMs = deadlineMs;
      await upsertUserDoc(cred.user.uid, { verificationDeadlineMs: deadlineMs });

      $("#reg-ok").classList.remove("hide");
      $("#reg-ok").textContent = "Cuenta creada. Hemos enviado un email de verificación (tienes 5 minutos). Revisa tu bandeja.";
      startVerifyCountdown(deadlineMs, $("#reg-msg"));
      refreshProfileGate();
    } catch (e) {
      $("#reg-error").classList.remove("hide");
      $("#reg-error").textContent = (""+e.message) || "No se pudo registrar.";
    }
  };

  $("#btn-resend-verify").onclick = async ()=>{
    if (!auth.currentUser) { $("#reg-msg").textContent="Inicia sesión para reenviar verificación."; return; }
    try {
      await sendEmailVerification(auth.currentUser, { url: window.location.origin + "/" });
      const deadlineMs = Date.now() + 5*60*1000;
      state.verificationDeadlineMs = deadlineMs;
      await upsertUserDoc(auth.currentUser.uid, { verificationDeadlineMs: deadlineMs });
      startVerifyCountdown(deadlineMs, $("#reg-msg"), "Reenviado. Expira en");
    } catch(e){ $("#reg-msg").textContent = "No se pudo reenviar: "+e.message; }
  };

  /*************** Login ***************/
  $("#btn-login").onclick = async ()=>{
    const username = $("#login-username").value.trim();
    const email = $("#login-email").value.trim();
    const pass = $("#login-pass").value;
    $("#login-msg").textContent = "";

    if (!username || !email || !pass) {
      $("#login-msg").textContent = "Coloca username, email y contraseña.";
      return;
    }
    try {
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      // guardar expectedUsername (para comparar con Discord)
      await upsertUserDoc(cred.user.uid, { expectedUsername: username });

      if (!cred.user.emailVerified) {
        // enviar verificación y mostrar contador (sin forzar logout)
        await sendEmailVerification(cred.user, { url: window.location.origin + "/" });
        const deadlineMs = Date.now() + 5*60*1000;
        state.verificationDeadlineMs = deadlineMs;
        await upsertUserDoc(cred.user.uid, { verificationDeadlineMs: deadlineMs });
        startVerifyCountdown(deadlineMs, $("#login-msg"),
          "Tu correo no está verificado. Te enviamos verificación. Expira en");
      } else {
        $("#login-msg").textContent = "Sesión iniciada.";
      }
      refreshProfileGate();
    } catch(e){ $("#login-msg").textContent = "Error de login: "+e.message; }
  };

  $("#btn-reset").onclick = async ()=>{
    const email = $("#login-email").value.trim() || $("#reg-email").value.trim();
    if (!email) { $("#login-msg").textContent = "Escribe tu email para enviar el reset."; return; }
    try {
      await sendPasswordResetEmail(auth, email);
      $("#login-msg").textContent = "Te enviamos un correo para restablecer contraseña.";
    } catch(e){ $("#login-msg").textContent = "No se pudo enviar: "+e.message; }
  };

  /*************** Discord Link (OAuth) ***************/
  async function connectDiscord() {
    if (!auth.currentUser) { alert("Inicia sesión primero."); return; }
    const expected = (state.userDoc && state.userDoc.expectedUsername) || (state.user && state.user.displayName) || "";
    // DEV: simulador sin backend (prompt)
    if (state.MOCK_DISCORD) {
      const discordUsername = prompt("DEV MODE: escribe el username de Discord para simular autorización:");
      if (!discordUsername) return;
      if (expected && discordUsername.trim().toLowerCase() !== expected.trim().toLowerCase()) {
        alert(`El username de Discord (${discordUsername}) NO coincide con el registrado (${expected}).`);
        return;
      }
      await upsertUserDoc(auth.currentUser.uid, {
        discordLinked:true, discordUsername
      });
      refreshProfileGate();
      return;
    }
    // PRODUCCIÓN: redirige a tu backend
    const qs = new URLSearchParams({
      uid: auth.currentUser.uid,
      expected: expected
    });
    window.location.href = `/api/discord/start?${qs.toString()}`;
  }
  // Botones
  $("#btn-login-discord").onclick = connectDiscord;
  $("#btn-reg-discord").onclick   = connectDiscord;

  // Callback handler (si tu backend te redirige con ?discord_username=XX&ok=1)
  (async function handleDiscordCallback(){
    const p = new URLSearchParams(location.search);
    if (!p.has("discord_username")) return;
    if (!auth.currentUser) return;
    const discordUsername = p.get("discord_username");
    const ok = p.get("ok")==="1";
    const expected = (state.userDoc && state.userDoc.expectedUsername) || (state.user && state.user.displayName) || "";
    if (!ok) { alert("Autorización de Discord cancelada."); return; }
    if (expected && discordUsername.trim().toLowerCase() !== expected.trim().toLowerCase()) {
      alert(`El username de Discord (${discordUsername}) NO coincide con el registrado (${expected}).`);
      return;
    }
    await upsertUserDoc(auth.currentUser.uid, { discordLinked:true, discordUsername });
    refreshProfileGate();
    // limpia query
    history.replaceState({}, "", location.pathname);
  })();

  /*************** Edit Profile: PFP ***************/
  $("#btn-set-pfp").onclick = ()=>$("#pfpDialog").showModal();
  $("#dlgClose").onclick = ()=>$("#pfpDialog").close();
  $("#btn-remove-pfp").onclick = async ()=>{
    if (!auth.currentUser) return;
    await upsertUserDoc(auth.currentUser.uid, { pfpUrl: null });
    refreshProfileGate();
  };

  // Carga catálogo de cartas (intenta remoto; fallback local)
  let cardsCatalog = [];
  async function loadCardsCatalog() {
    try {
      const r = await fetch("https://sekai.best/api/cards.json", {cache:"no-store"});
      if (!r.ok) throw new Error("HTTP "+r.status);
      cardsCatalog = await r.json();
    } catch (_e) {
      // Fallback local
      try {
        const r2 = await fetch("./cards.json", {cache:"no-store"});
        cardsCatalog = await r2.json();
      } catch(e2) {
        // fallback mínimo manual para no romper UI
        cardsCatalog = [
          { id: 1, name: "Sample Card A", trainedImg:"https://via.placeholder.com/256?text=A+trained",
            untrainedImg:"https://via.placeholder.com/256?text=A" },
          { id: 2, name: "Sample Card B", trainedImg:"https://via.placeholder.com/256?text=B+trained",
            untrainedImg:"https://via.placeholder.com/256?text=B" },
        ];
      }
    }
  }

  function cardToTiles(card) {
    // intenta mapear campos comunes; si tu JSON tiene otros nombres, ajusta aquí
    const title = card.title || card.name || ("Card "+card.id);
    // heurística de urls (ajústala a tu JSON real):
    const trained   = card.trainedImg   || card.trained  || card.after_training  || card.image_trained;
    const untrained = card.untrainedImg || card.untrained|| card.before_training || card.image;
    return [
      { url: trained,   label: title+" (entrenada)"   },
      { url: untrained, label: title+" (no entrenada)"}
    ].filter(x=>!!x.url);
  }

  async function renderCards(filter="") {
    if (!cardsCatalog.length) await loadCardsCatalog();
    const grid = $("#cardsGrid");
    grid.innerHTML = "";
    const q = filter.trim().toLowerCase();
    let shown = 0;

    for (const c of cardsCatalog) {
      const hay = (c.title||c.name||"").toLowerCase();
      if (q && !hay.includes(q) && (""+c.id)!==q) continue;

      for (const tile of cardToTiles(c)) {
        const div = document.createElement("div");
        div.className = "card-tile";
        div.innerHTML = `<img loading="lazy" src="${tile.url}"><div>${tile.label}</div>`;
        div.onclick = async ()=>{
          if (!auth.currentUser) { alert("Inicia sesión."); return; }
          await upsertUserDoc(auth.currentUser.uid, { pfpUrl: tile.url });
          $("#pfpDialog").close();
          refreshProfileGate();
          // si el usuario existe en leaderboard, actualiza pfp in-memory
          const me = players.find(p=>p.name.toLowerCase()===(state.userDoc?.discordUsername||"").toLowerCase()
            || p.name.toLowerCase()===(state.user?.displayName||"").toLowerCase());
          if (me) { me.pfp = tile.url; renderLeaderboard(); }
        };
        grid.appendChild(div);
        shown++;
      }
    }
    if (!shown) {
      grid.innerHTML = `<div class="msg">No se encontraron cartas para “${filter}”.</div>`;
    }
  }

  $("#reloadCards").onclick = ()=>renderCards($("#cardSearch").value);
  $("#cardSearch").addEventListener("input", (e)=>renderCards(e.target.value));

  /*************** Leaderboard UI ***************/
  function buildRankMenu() {
    const m = $("#rankMenu");
    m.innerHTML = "";
    RANKS.forEach(([name, lo, hi])=>{
      const { label } = formatRankItem([name, lo, hi]);
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML =
        `<span class="grad ${rankClass(name)}">${label}</span>
         <span class="count-badge" id="count-${name}">0</span>`;
      item.onclick = ()=>applyRankFilter(name);
      m.appendChild(item);
    });
  }

  function applyRankFilter(name) {
    state.selectedRank = name;
    $("#rankMenu").classList.remove("open");
    const filtered = players.filter(p=>p.rank===name);
    $("#rankBtn").innerHTML = `Rango: <span class="grad ${rankClass(name)}" style="font-weight:700">${name}</span> (${filtered.length})`;
    $("#btn-show-all").classList.remove("hide");
    renderLeaderboard();
  }

  $("#rankBtn").onclick = ()=>{
    $("#rankMenu").classList.toggle("open");
  };
  document.addEventListener("click", (e)=>{
    if (!$("#rankDropdown").contains(e.target)) $("#rankMenu").classList.remove("open");
  });
  $("#btn-show-all").onclick = ()=>{
    state.selectedRank=null;
    $("#rankBtn").textContent = "Rangos (Todos)";
    $("#btn-show-all").classList.add("hide");
    renderLeaderboard();
  };

  function renderLeaderboard() {
    // recalcular rank por mmr si hace falta
    players.forEach(p=>p.rank = getRankNameByMMR(p.mmr));
    // contadores
    RANKS.forEach(([name])=>{
      const n = players.filter(p=>p.rank===name).length;
      const el = document.getElementById(`count-${name}`);
      if (el) el.textContent = n;
    });

    const tbody = $("#lb-body");
    tbody.innerHTML = "";
    let view = players.slice();
    if (state.selectedRank) view = view.filter(p=>p.rank===state.selectedRank);
    view.sort((a,b)=>b.mmr-a.mmr);

    view.forEach((p, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="flagCell"><div class="flag" title="${p.country||''}"></div></td>
        <td>
          <div class="cell">
            ${p.pfp ? `<img class="avatar" src="${p.pfp}">` : ``}
            <div>${p.name}</div>
          </div>
        </td>
        <td><span class="grad ${rankClass(p.rank)}" style="font-weight:700">${p.rank}</span></td>
        <td>${p.mmr}</td>`;
      tbody.appendChild(tr);
    });
  }

  /*************** Inicialización UI ***************/
  buildRankMenu();
  renderLeaderboard();
  renderCards(""); // precarga silenciosa

  // Cuando se entra a “Edit Profile”, refrescamos el gate
  document.querySelector('[data-route="profile"]').addEventListener("click", refreshProfileGate);

  // (Opcional) activar mock de Discord con F12:
  // state.MOCK_DISCORD = true;

</script>
</body>
</html>


