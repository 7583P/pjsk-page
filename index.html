<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PJSK LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#383838; --panel:#2a2a2a; --panel2:#242424; --ink:#fff; --muted:#bfbfbf;
      --brand:#6c6cf0; --warn:#f0a66c; --ok:#58d68d; --err:#ff6b6b; --line:#0006;
      --row1:#333; --row2:#2a2a2a; --hover:#595959; --chip:#444;
      --rowh:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    #app{min-height:100%}

    /* Topbar */
    header.topbar{position:sticky;top:0;z-index:5;background:var(--panel);border-bottom:1px solid var(--line)}
    .topwrap{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
    .brand{font-weight:700;letter-spacing:.5px}
    nav.tabs{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap}
    .tabbtn{padding:8px 12px;border-radius:8px;background:#0000;border:1px solid #0000;color:var(--ink);cursor:pointer;transition:.15s background}
    .tabbtn:hover{background:var(--hover)}
    .tabbtn.active{background:var(--brand);border-color:#0000}

    /* Layout */
    .container{max-width:1100px;margin:20px auto;padding:20px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 0 14px rgba(0,0,0,.35);padding:18px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:980px){ .grid.cols-2{grid-template-columns:1fr} }

    /* Home hero */
    .hero{text-align:center;padding:28px;border-radius:12px;background:linear-gradient(135deg,#2a2a2a 0%, #242424 100%);border:1px solid var(--line);margin-bottom:16px}
    .hero h1{font-size:clamp(28px,5vw,48px);margin:0 0 6px}
    .hero p{margin:0;color:var(--muted)}

    /* Forms + msgs */
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{font-size:.92rem;color:var(--muted)}
    input, select{padding:10px 12px;border-radius:10px;border:1px solid #0008;background:var(--panel2);color:var(--ink);outline:none}
    input:focus, select:focus{border-color:var(--brand)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #0000;background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
    .btn.ghost{background:#0000;border-color:#00000055}
    .btn.warn{background:var(--warn);color:#000}
    .btn.full{width:100%}
    .help{font-size:.9rem;color:var(--muted)}
    .msg{padding:10px 12px;border-radius:10px;margin:10px 0;font-size:.95rem}
    .msg.ok{background:#1e3b2e;color:#d6ffe7;border:1px solid #2a6c4b}
    .msg.err{background:#3b1e1e;color:#ffd6d6;border:1px solid #6c2a2a}
    .msg.info{background:#1e263b;color:#d6e4ff;border:1px solid #2a3f6c}

    section{display:none}
    section.active{display:block}

    /* ===================== Leaderboard (Vue) ===================== */
    #lbApp h1{font-size:2em;margin-bottom:20px;text-align:center}
    #lbApp .controls{margin-bottom:15px;text-align:center}
    #lbApp .controls input[type="text"]{
      padding:5px;width:80%;max-width:400px;border:none;border-radius:4px;text-align:center;background:#555;color:#fff
    }

    /* Dropdown */
    #lbApp .dropdown{position:relative;display:inline-block;margin-left:10px}
    #lbApp .dropbtn{background:#737373;border:none;padding:6px 12px;cursor:pointer;border-radius:4px;color:#fff;font-weight:bold;white-space:nowrap}
    #lbApp .dropdown-content{position:absolute;top:100%;left:0;min-width:220px;background:#595959;box-shadow:0 2px 6px rgba(0,0,0,.2);z-index:1000;border-radius:4px;overflow:hidden}
    #lbApp .dropdown-content a{display:block;padding:8px 12px;text-decoration:none;font-size:14px;white-space:nowrap;color:#fff}
    #lbApp .dropdown-content a:hover .text-gradient{opacity:.9}

    /* Gradients base */
    #lbApp .text-gradient, #lbApp .name-gradient{
      display:inline-block;background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent
    }

    /* Table */
    #lbApp table{width:100%;border-collapse:collapse;margin-top:10px}
    #lbApp th, #lbApp td{padding:10px;text-align:center;color:#fff}
    #lbApp th{background:#030050}
    #lbApp td{border-bottom:1px solid #555}
    #lbApp tbody tr:nth-child(odd){background:#333}
    #lbApp tbody tr:nth-child(even){background:#2a2a2a}

    /* Position + flag */
    #lbApp .position-cell{position:relative;text-align:center;padding-right:56px}
    #lbApp .position-cell .position-number{display:inline-block}
    #lbApp .position-cell .flag{width:24px;position:absolute;top:50%;right:8px;transform:translateY(-50%)}

    /* Emojis sin degradado */
    #lbApp .name-gradient .emoji{
      background:none !important; -webkit-background-clip:initial !important; -webkit-text-fill-color:currentColor !important
    }

    /* Paginación */
    #lbApp .pagination{margin-top:15px;display:flex;justify-content:center;align-items:center;gap:8px}
    #lbApp .pagination button{padding:4px 8px;border:none;border-radius:4px;background:#555;color:#fff;cursor:pointer}
    #lbApp .pagination button:disabled{opacity:.4;cursor:default}
    #lbApp .pagination input[type="number"]{width:50px;padding:4px;text-align:center;border-radius:4px;border:1px solid #555;background:#2a2a2a;color:#fff}

    /* Rank gradients (→ izquierda) */
    .rank-Placement   { background-image: linear-gradient(to left, #ff7000, #ff4600); }
    .rank-Iron        { background-image: linear-gradient(to left, #616161, #2e2e2e); }
    .rank-Bronze      { background-image: linear-gradient(to left, #6d2a00, #3d1d00); }
    .rank-Silver      { background-image: linear-gradient(to left, #b3b3b3, #696969); }
    .rank-Gold        { background-image: linear-gradient(to left, #ffbf60, #c57600); }
    .rank-Platinum    { background-image: linear-gradient(to left, #767ec2, #38429f); }
    .rank-Diamond     { background-image: linear-gradient(to left, #42a2ff, #003e8f); }
    .rank-Crystal     { background-image: linear-gradient(to left, #dca3ff, #883cb4); }
    .rank-Master      { background-image: linear-gradient(to left, #c34efd, #5f009e); }
    .rank-Champion    { background-image: linear-gradient(to left, #fe6767, #8f0000); }
    .rank-GrandChampion { background-image: linear-gradient(to left, #ff0800, #570300); white-space:nowrap; }
    .rank-Legend      { background-image: linear-gradient(to left, #c9f4ff, #c9f4ff); }

    /* ===================== /Leaderboard (Vue) ===================== */
  </style>
</head>
<body>
<div id="app">
  <header class="topbar">
    <div class="topwrap">
      <div class="brand">PJSK LOUNGE</div>
      <nav class="tabs" id="tabs">
        <button class="tabbtn active" data-tab="home">Home</button>
        <button class="tabbtn" data-tab="leaderboard">Leaderboard</button>
        <button class="tabbtn" data-tab="profile">Edit Profile</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="home" class="active">
      <div class="hero card">
        <h1>Welcome to PJSK LOUNGE</h1>
        <p>New project of competitive PJSK with a Discord bot and a dedicated page.</p>
      </div>

      <div id="authArea" class="grid cols-2">
        <!-- Login -->
        <div class="card">
          <h2 style="margin:0 0 10px">Iniciar sesión</h2>
          <div class="field">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="usuario123@email.com" autocomplete="username" />
          </div>
          <div class="field">
            <label for="loginPass">Contraseña</label>
            <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password" />
          </div>
          <button id="btnLogin" class="btn full">Entrar</button>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <button id="btnReset" class="btn ghost">Reset password</button>
            <span class="help">¿Sin verificar? <a href="#" id="btnResendFromLogin">Reenviar verificación</a></span>
          </div>
          <div id="loginMsg"></div>
        </div>

        <!-- Register -->
        <div class="card">
          <h2 style="margin:0 0 10px">Crear cuenta</h2>
          <div class="field">
            <label for="regDisplay">Nombre a mostrar (opcional)</label>
            <input id="regDisplay" type="text" placeholder="usuario123" />
          </div>
          <div class="field">
            <label for="regEmail">Email</label>
            <input id="regEmail" type="email" placeholder="usuario123@email.com" autocomplete="email" />
          </div>
          <div class="field">
            <label for="regPass">Contraseña</label>
            <input id="regPass" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />
          </div>
          <button id="btnRegister" class="btn full">Registrarme</button>
          <div id="regMsg"></div>
        </div>
      </div>

      <div id="welcomeArea" class="card" style="display:none">
        <h2 style="margin:0 0 6px">¡Hola, <span id="welcomeName">usuario123</span>!</h2>
        <p class="help" style="margin:0 0 12px">Ya iniciaste sesión.</p>
        <div id="verifyBanner" class="banner" style="display:none"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="btnLogout" class="btn">Cerrar sesión</button>
          <button id="btnGoProfile" class="btn ghost">Ir a Edit Profile</button>
          <button id="btnResendVerify" class="btn warn" style="display:none">Reenviar verificación</button>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD (Vue) -->
    <section id="leaderboard">
      <div class="card">
        <div id="lbApp">
          <h1>PJSK LOUNGE – Season {{ seasonLabel }}</h1>

          <div class="controls">
            <input type="text" v-model="filter" placeholder="Buscar por nombre…" v-if="!selectedRank">

            <!-- ▼ Dropdown Rangos -->
            <div class="dropdown" @click.stop>
              <button class="dropbtn" @click.stop="menuOpen = !menuOpen">
                <template v-if="selectedRank">
                  <span :class="['text-gradient','rank-'+selectedRank]">Filtrar por {{ displayRank(selectedRank) }}</span>
                  <span :class="['text-gradient','rank-'+selectedRank]">({{ filteredCount }}) ▾</span>
                </template>
                <template v-else>
                  <span class="text-gradient rank-Legend">Rangos ▾</span>
                </template>
              </button>
              <div id="rankList" class="dropdown-content" v-show="menuOpen">
                <a v-for="r in ranks" :key="r.key" href="#" @click.prevent="selectRank(r.key)">
                  <span :class="['text-gradient','rank-'+r.key]">
                    {{ r.label }} ({{ r.range }})
                  </span>
                </a>
              </div>
            </div>
            <!-- ▲ -->

            <button v-if="selectedRank" @click="clearRank" style="margin-left:10px;background:#555;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">
              Mostrar todos ▾
            </button>
          </div>

          <table>
            <thead>
              <tr><th>#</th><th>Player</th><th>MMR</th><th>Rango</th></tr>
            </thead>
            <tbody>
              <tr v-for="p in paginatedPlayers" :key="p.id">
                <td class="position-cell">
                  <span :class="['position-number','text-gradient','rank-'+p.rank]">{{ playerRankMap[p.id] }}</span>
                  <img v-if="p.country" :src="flagUrl(p.country)" :alt="p.country" class="flag" />
                </td>
                <td>
                  <span :class="['name-gradient','rank-'+p.rank]">
                    <template v-for="(seg, idx) in splitName(p.name)" :key="idx">
                      <span v-if="seg.isEmoji" class="emoji">{{ seg.char }}</span>
                      <span v-else>{{ seg.char }}</span>
                    </template>
                  </span>
                </td>
                <td><span :class="['text-gradient','rank-'+p.rank]">{{ p.mmr }}</span></td>
                <td><span :class="['text-gradient','rank-'+p.rank]">{{ displayRank(p.rank) }}</span></td>
              </tr>
            </tbody>
          </table>

          <div class="pagination">
            <button @click="prevPage" :disabled="currentPage<=1">&laquo;</button>
            <input type="number" v-model.number="currentPage" @keyup.enter="goToPage" :min="1" :max="totalPages" />
            <span>/ {{ totalPages }}</span>
            <button @click="nextPage" :disabled="currentPage>=totalPages">&raquo;</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE: Set PFP (tal como lo tenías) -->
    <section id="profile">
      <div class="card">
        <h2 style="margin:0 0 10px">Set PFP</h2>
        <p class="help" style="margin:0 0 12px">
          Busca y selecciona cualquier carta (no entrenada / entrenada). Al hacer click, tu PFP se guarda.
        </p>

        <div class="pfp-toolbar">
          <input id="pfpSearch" type="text" placeholder="Buscar por nombre, id, personaje..." style="min-width:260px">
          <select id="pfpVersion">
            <option value="both">Mostrar: ambas versiones</option>
            <option value="normal">Solo no entrenada</option>
            <option value="trained">Solo entrenada</option>
          </select>
          <button id="btnClearPfp" class="btn warn">Eliminar PFP</button>
        </div>

        <div id="pfpInfo" class="msg info" style="display:none"></div>
        <div id="pfpGrid" class="pfp-grid"></div>
        <div id="pfpSelected" class="selected-note help"></div>
      </div>
    </section>
  </main>
</div>

<!-- Vue 3 + Axios (para el Leaderboard) -->
<script src="https://unpkg.com/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- Leaderboard App (Vue) -->
<script>
  const { createApp } = Vue;

  createApp({
    data(){
      return {
        players: [],
        filter: '',
        playerRankMap: {},
        currentPage: 1,
        pageSize: 50,
        selectedRank: null,
        menuOpen: false,
        ranks: [
          { key:'Iron', label:'Iron', range:'0-100' },
          { key:'Bronze', label:'Bronze', range:'101-200' },
          { key:'Silver', label:'Silver', range:'201-300' },
          { key:'Gold', label:'Gold', range:'301-400' },
          { key:'Platinum', label:'Platinum', range:'401-500' },
          { key:'Diamond', label:'Diamond', range:'501-600' },
          { key:'Crystal', label:'Crystal', range:'601-700' },
          { key:'Master', label:'Master', range:'701-800' },
          { key:'Champion', label:'Champion', range:'801-900' },
          { key:'GrandChampion', label:'Grand Champion', range:'901-999' },
          { key:'Legend', label:'Legend', range:'+1000' }
        ]
      }
    },
    computed:{
      filteredPlayers(){
        let list = this.players;
        if (this.selectedRank) {
          list = list.filter(p => p.rank === this.selectedRank);
        } else if (this.filter) {
          const q = this.filter.toLowerCase();
          list = list.filter(p => (p.name||'').toLowerCase().includes(q));
        }
        return list;
      },
      filteredCount(){
        if(!this.selectedRank) return 0;
        return this.players.filter(p => p.rank === this.selectedRank).length;
      },
      totalPages(){
        return Math.max(1, Math.ceil(this.filteredPlayers.length / this.pageSize));
      },
      paginatedPlayers(){
        const start = (this.currentPage - 1) * this.pageSize;
        return this.filteredPlayers.slice(start, start + this.pageSize);
      },
      seasonLabel(){ return 'Beta'; }
    },
    watch:{
      filter(){ this.currentPage = 1; },
      selectedRank(){ this.currentPage = 1; this.filter = ''; },
      currentPage(val){
        if(val < 1) this.currentPage = 1;
        else if (val > this.totalPages) this.currentPage = this.totalPages;
      }
    },
    methods:{
      selectRank(rank){ this.selectedRank = rank; this.menuOpen = false; },
      clearRank(){ this.selectedRank = null; },
      prevPage(){ if(this.currentPage > 1) this.currentPage--; },
      nextPage(){ if(this.currentPage < this.totalPages) this.currentPage++; },
      goToPage(){ /* ya validado por watch */ },
      async fetchPlayers(){
        try{
          const resp = await axios.get('https://worker-production-1ad2.up.railway.app/api/players', { timeout: 10000 });
          const sorted = (resp.data || []).slice().sort((a,b)=> (b.mmr||0) - (a.mmr||0));
          this.players = sorted;
          const map = {};
          sorted.forEach((p,i)=> map[p.id] = i+1);
          this.playerRankMap = map;
        }catch(err){
          console.error('Error API players:', err?.message || err);
          // Fallback de ejemplo (usuario123)
          const demo = Array.from({length:60}).map((_,i)=>({
            id: 'demo'+i,
            name: i%7===0 ? 'usuario123' : ('usuario'+(100+i)),
            mmr: 1000 - i*7,
            rank: ['Gold','Platinum','Diamond','Bronze','Silver','Master','Legend'][i%7],
            country: i%2===0 ? 'pe' : 'us'
          })).sort((a,b)=> b.mmr - a.mmr);
          const map = {}; demo.forEach((p,i)=> map[p.id]=i+1);
          this.players = demo; this.playerRankMap = map;
        }
      },
      flagUrl(cc){ return `https://flagcdn.com/24x18/${String(cc||'').toLowerCase()}.png`; },
      displayRank(rank){ return rank==='GrandChampion' ? 'Grand Champion' : rank; },
      splitName(name){
        const emojiPres = /\p{Emoji_Presentation}/u;
        return Array.from(String(name||'')).map(c=>({ char:c, isEmoji: emojiPres.test(c) }));
      },
      onDocClick(e){
        // Cierra menú de rangos si se hace click fuera
        const dd = document.querySelector('#lbApp .dropdown');
        if(!dd?.contains(e.target)) this.menuOpen = false;
      }
    },
    mounted(){
      this.fetchPlayers();
      this._timer = setInterval(this.fetchPlayers, 10000);
      document.addEventListener('click', this.onDocClick);
    },
    unmounted(){
      if(this._timer) clearInterval(this._timer);
      document.removeEventListener('click', this.onDocClick);
    }
  }).mount('#lbApp');
</script>

<!-- Firebase (Auth + PFP picker, igual que antes) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    sendEmailVerification, sendPasswordResetEmail, signOut, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, updateDoc, getDoc, getDocs, collection, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_BUCKET",
    messagingSenderId: "TU_SENDER_ID",
    appId: "TU_APP_ID",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $  = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const show = (el, on=true)=> el && (el.style.display = on ? "" : "none");

  function showMsg(el, text, type){ el.className = "msg " + (type||"info"); el.textContent = text; el.style.display = text ? "block" : "none"; }

  // Tabs (delegación robusta)
  function setActiveTab(name){
    $$(".tabbtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
    $$("main section").forEach(s=>s.classList.toggle("active", s.id===name));
  }
  $("#tabs").addEventListener("click", (e)=>{
    const btn = e.target.closest(".tabbtn");
    if(btn && btn.dataset.tab) setActiveTab(btn.dataset.tab);
  });

  // ===== Auth =====
  $("#btnRegister").addEventListener("click", async ()=>{
    const email = $("#regEmail").value.trim();
    const pass  = $("#regPass").value.trim();
    const display = $("#regDisplay").value.trim();
    const el = $("#regMsg"); showMsg(el,"","info");
    if(!email || !pass){ showMsg(el,"Completa email y contraseña.","err"); return; }
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      if(display){ await updateProfile(cred.user, { displayName: display }); }
      await setDoc(doc(db,"users",cred.user.uid), {
        uid: cred.user.uid, email, displayName: display||"",
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      }, {merge:true});
      await sendEmailVerification(cred.user);
      showMsg(el,"Te enviamos un correo de verificación. Revisa tu bandeja y spam.","ok");
      $("#regPass").value="";
    }catch(err){
      const map={"auth/email-already-in-use":"Ese email ya está registrado.","auth/invalid-email":"Email inválido.","auth/weak-password":"La contraseña es muy débil (mínimo 6)."};
      showMsg(el, map[err.code] || ("Error al registrar: "+err.message), "err");
    }
  });

  $("#btnLogin").addEventListener("click", async ()=>{
    const email = $("#loginEmail").value.trim();
    const pass  = $("#loginPass").value.trim();
    const el = $("#loginMsg"); showMsg(el,"","info");
    if(!email || !pass){ showMsg(el,"Completa email y contraseña.","err"); return; }
    try{
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      if(!cred.user.emailVerified){
        showMsg(el,"Login exitoso, pero tu correo no está verificado. Puedes reenviar la verificación.","info");
      }else{ showMsg(el,"","info"); }
    }catch(err){
      const map={"auth/invalid-email":"Email inválido.","auth/user-disabled":"Usuario deshabilitado.","auth/user-not-found":"No existe cuenta con ese email.","auth/wrong-password":"Contraseña incorrecta."};
      showMsg(el, map[err.code] || ("Error al iniciar sesión: "+err.message), "err");
    }
  });

  $("#btnReset").addEventListener("click", async ()=>{
    const email = $("#loginEmail").value.trim() || prompt("Escribe tu email para enviar el reset:");
    if(!email) return;
    try{ await sendPasswordResetEmail(auth,email); showMsg($("#loginMsg"),"Te enviamos un correo para resetear tu contraseña.","ok"); }
    catch(err){ showMsg($("#loginMsg"),"No pudimos enviar el reset: "+err.message,"err"); }
  });

  $("#btnResendFromLogin").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(!auth.currentUser){ showMsg($("#loginMsg"),"Primero inicia sesión para reenviar verificación.","err"); return; }
    try{ await sendEmailVerification(auth.currentUser); showMsg($("#loginMsg"),"Correo de verificación reenviado.","ok"); }
    catch(err){ showMsg($("#loginMsg"),"No se pudo reenviar: "+err.message,"err"); }
  });

  onAuthStateChanged(auth, async (user)=>{
    const authArea = $("#authArea"), welcomeArea=$("#welcomeArea");
    if(user){
      show(authArea,false); show(welcomeArea,true);
      $("#welcomeName").textContent = user.displayName || (user.email?.split("@")[0]) || "usuario123";
      const vb = $("#verifyBanner"), btnResend = $("#btnResendVerify");
      if(user.emailVerified){ show(vb,false); show(btnResend,false); } else {
        show(vb,true); vb.className = "msg info"; vb.innerHTML="Tu correo aún no está verificado. Revisa tu bandeja o <strong>reenvía la verificación</strong>.";
        show(btnResend,true);
      }
    }else{
      show(welcomeArea,false); show(authArea,true);
    }
  });

  $("#btnResendVerify").addEventListener("click", async ()=>{
    if(!auth.currentUser) return;
    try{ await sendEmailVerification(auth.currentUser); showMsg($("#verifyBanner"),"Correo de verificación reenviado.","ok"); }
    catch(err){ showMsg($("#verifyBanner"),"No se pudo reenviar: "+err.message,"err"); }
  });
  $("#btnLogout").addEventListener("click", async ()=>{ await signOut(auth); });
  $("#btnGoProfile").addEventListener("click", ()=> setActiveTab("profile"));

  // ===== Set PFP (sekai.best) =====
  const IMAGE_BASES = [
    "https://sekai-res.dnaroma.eu/file/sekai-assets/thumbnail/chara_card/",
    "https://storage.sekai.best/sekai-assets/thumbnail/chara_card/",
  ];
  const CARD_APIS = [
    "https://sekai.best/api/v2/cards.json",
    "https://sekai.best/api/cards.json",
    "https://sekai.best/api/cards",
  ];

  function cardImageUrls(assetbundleName){
    const fileNormal  = `${assetbundleName}_normal.png`;
    const fileTrained = `${assetbundleName}_after_training.png`;
    return { normal: IMAGE_BASES[0] + fileNormal, trained: IMAGE_BASES[0] + fileTrained };
  }
  function normalizeCard(c){
    const id = c.id || c.cardId || c.resourceId || c.seq || c.card_id || c.assetbundleName || c.assetBundleName;
    const asset = c.assetbundleName || c.assetBundleName || c.assetbundle || c.assetBundle;
    const name = c.name || c.title || c.cardName || "";
    if(!asset) return null;
    const urls = cardImageUrls(asset);
    return { id: id ?? asset, assetbundleName: asset, name, imgNormal: urls.normal, imgTrained: urls.trained };
  }

  const statePFP = { cards: [], filtered: [], version: "both", search: "", selectedUrl: "" };
  $("#pfpVersion").addEventListener("change", ()=>{ statePFP.version=$("#pfpVersion").value; filterCards(); renderCardGrid(); });
  $("#pfpSearch").addEventListener("input",  ()=>{ statePFP.search=$("#pfpSearch").value.trim().toLowerCase(); filterCards(); renderCardGrid(); });
  $("#btnClearPfp").addEventListener("click", async ()=>{
    const u = auth.currentUser; if(!u) return;
    try{
      await updateDoc(doc(db,"users",u.uid), { pfpUrl:"", updatedAt:serverTimestamp() });
      statePFP.selectedUrl = ""; $("#pfpSelected").textContent = "PFP eliminado.";
    }catch(err){ showMsg($("#pfpInfo"), "No se pudo eliminar el PFP: "+err.message, "err"); }
  });

  async function fetchCards(){
    const info = $("#pfpInfo");
    showMsg(info,"Cargando cartas…","info");
    let ok=false, raw=null;
    for(const api of CARD_APIS){
      try{ const res = await fetch(api); if(res.ok){ raw = await res.json(); ok=true; break; } }catch{}
    }
    if(!ok){ showMsg(info,"No pudimos leer la lista de cartas desde sekai.best.","err"); return; }
    const list = Array.isArray(raw)? raw : (raw.data || raw.cards || raw.result || []);
    const mapped = [];
    for(const item of list){ const m = normalizeCard(item); if(m) mapped.push(m); }
    statePFP.cards = mapped; filterCards(); renderCardGrid();
    showMsg(info,`Cartas cargadas: ${mapped.length}. Usa el buscador.`, "ok");
  }
  function filterCards(){
    const q = statePFP.search, ver=statePFP.version;
    statePFP.filtered = statePFP.cards.filter(c=>{
      return (c.name||"").toLowerCase().includes(q) || String(c.id).toLowerCase().includes(q) || c.assetbundleName.toLowerCase().includes(q);
    }).map(c=>{
      if(ver==="normal") return [{...c, show:"normal"}];
      if(ver==="trained") return [{...c, show:"trained"}];
      return [{...c, show:"normal"}, {...c, show:"trained"}];
    }).flat();
  }
  function renderCardGrid(){
    const grid = $("#pfpGrid");
    if(statePFP.filtered.length===0){ grid.innerHTML = `<div class="help">Sin resultados. Prueba con otro término.</div>`; return; }
    grid.innerHTML = statePFP.filtered.map(c=>{
      const img = c.show==="trained" ? c.imgTrained : c.imgNormal;
      const labelVer = c.show==="trained" ? "Trained" : "Normal";
      return `
        <div class="card-tile" data-url="${img}" title="#${c.id}">
          <img class="tile-img" loading="lazy" src="${img}" alt="#${c.id}">
          <div class="tile-meta">
            <span class="badge">${labelVer}</span>
            <span>#${c.id}</span>
          </div>
        </div>`;
    }).join("");
    $$(".card-tile").forEach(tile=>{
      tile.addEventListener("click", async ()=>{
        const url = tile.dataset.url;
        const u = auth.currentUser;
        if(!u){ setActiveTab("home"); alert("Inicia sesión para guardar tu PFP."); return; }
        try{
          await updateDoc(doc(db,"users",u.uid), { pfpUrl:url, updatedAt:serverTimestamp() });
          statePFP.selectedUrl = url; $("#pfpSelected").textContent="PFP actualizado ✔";
        }catch(err){ showMsg($("#pfpInfo"), "No se pudo guardar el PFP: "+err.message, "err"); }
      });
    });
  }

  fetchCards();
</script>
</body>
</html>


