<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PJSK LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#1e1e1e; --panel:#22252b; --panel2:#1b1e23; --ink:#fff; --muted:#bfc5d0;
      --brand:#6c6cf0; --warn:#f0a66c; --ok:#58d68d; --err:#ff6b6b; --line:#0006;
      --hover:#2f3541; --chip:#2a2f3a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    header.topbar{background:var(--panel);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:50}
    nav{display:flex;gap:10px;max-width:1100px;margin:0 auto;padding:12px}
    .navlink{padding:10px 14px;border-radius:10px;background:transparent;cursor:pointer}
    .navlink.active{background:#2a2f3a}

    main,section.view{max-width:1100px;margin:18px auto;padding:0 12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
    .card.warn{background:#2a1e1e}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--panel2);color:var(--ink)}
    button{padding:10px 14px;border:none;border-radius:10px;background:var(--brand);color:#fff;cursor:pointer}
    button.ghost{background:#444}
    button.secondary{background:#3b3f48}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .msg{margin-top:8px;color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}

    /* bandera + pfp alineados verticalmente */
    .row.pfp{align-items:center}
    .flagSlot{width:48px;height:48px;display:flex;align-items:center;justify-content:center}
    .pfpSlot{width:48px;height:48px;display:flex;align-items:center;justify-content:center}
    #pfpImg{width:48px;height:48px;object-fit:cover;border-radius:6px}

    /* Leaderboard */
    table.lb{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#1f232a;position:sticky;top:0;padding:10px;text-align:left}
    tbody td{padding:10px;border-bottom:1px solid #3a3a3a} /* l√≠nea gris horizontal */
    .dropdown{position:relative}
    #rankToggle{min-width:280px;display:flex;justify-content:space-between;align-items:center}
    .menu{display:none;position:absolute;top:110%;left:0;background:#2a2f3a;border:1px solid var(--line);border-radius:12px;padding:8px;min-width:280px;z-index:20;max-height:360px;overflow:auto}
    .menu .item{padding:10px;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;gap:12px}
    .menu .item:hover{background:#363c48}

    /* Gradientes de texto para rangos (se aplican al texto con .gradtext) */
    .rank-Placement   { background-image: linear-gradient(to left, #ff7000, #ff4600); }
    .rank-Iron        { background-image: linear-gradient(to left, #616161, #2e2e2e); }
    .rank-Bronze      { background-image: linear-gradient(to left, #6d2a00, #3d1d00); }
    .rank-Silver      { background-image: linear-gradient(to left, #b3b3b3, #696969); }
    .rank-Gold        { background-image: linear-gradient(to left, #ffbf60, #c57600); }
    .rank-Platinum    { background-image: linear-gradient(to left, #767ec2, #38429f); }
    .rank-Diamond     { background-image: linear-gradient(to left, #42a2ff, #003e8f); }
    .rank-Crystal     { background-image: linear-gradient(to left, #dca3ff, #883cb4); }
    .rank-Master      { background-image: linear-gradient(to left, #c34efd, #5f009e); }
    .rank-Champion    { background-image: linear-gradient(to left, #fe6767, #8f0000); }
    .rank-GrandChampion { background-image: linear-gradient(to left, #ff0800, #570300); white-space: nowrap; }
    .rank-Legend      { background-image: linear-gradient(to left, #c9f4ff, #c9f4ff); }
    .gradtext { -webkit-background-clip:text; background-clip:text; color:transparent; }

    /* Modal de cartas */
    dialog{max-width:960px;width:92%;background:#1b1e23;border:1px solid var(--line);border-radius:12px;color:#fff}
    #cardGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:12px;max-height:420px;overflow:auto}
    .cardItem{cursor:pointer;border:1px solid var(--line);border-radius:8px;padding:6px;background:#22252b}
    .cardItem img{width:100%;height:160px;object-fit:cover;border-radius:6px}
  </style>
</head>
<body>
  <header class="topbar">
    <nav>
      <a id="navHome" class="navlink active">Home</a>
      <a id="navLb" class="navlink">Leaderboard</a>
      <a id="navEdit" class="navlink">Edit Profile</a>
    </nav>
  </header>

  <!-- HOME -->
  <main id="viewHome" class="view">
    <h1 style="margin:8px 0 16px">Welcome to PJSK LOUNGE</h1>
    <div class="grid-2">
      <!-- LOGIN -->
      <section class="card">
        <h2>Log in</h2>
        <label>Discord username o Showname</label>
        <input id="li-username" placeholder="usuario#0001 o showname" />
        <label>Email</label>
        <input id="li-email" type="email" placeholder="email@dominio.com" />
        <label>Contrase√±a</label>
        <input id="li-pass" type="password" />
        <div class="row">
          <button id="btnLogin">Entrar</button>
          <button id="btnLoginDiscord" class="secondary">Conectar con Discord</button>
          <button id="btnReset" class="ghost">Reset password</button>
        </div>
        <p id="li-msg" class="msg"></p>
      </section>

      <!-- REGISTER -->
      <section class="card">
        <h2>Register</h2>
        <label>Discord username o Showname</label>
        <input id="rg-username" placeholder="perumatias o perumatias#1234" />
        <label>Email</label>
        <input id="rg-email" type="email" placeholder="correo@dominio.com" />
        <label>Contrase√±a</label>
        <input id="rg-pass" type="password" />
        <div class="row">
          <button id="btnRegister">Crear cuenta</button>
          <button id="btnRegDiscord" class="secondary">Conectar con Discord</button>
        </div>
        <p id="rg-msg" class="msg"></p>
      </section>
    </div>

    <div class="card">
      <p><strong>Importante:</strong> Para <em>editar tu PFP</em> primero debes <strong>verificar tu email</strong> (tienes 5 minutos desde que se env√≠a) y <strong>vincular tu Discord</strong>. El nombre de Discord debe <strong>coincidir</strong> con el que escribiste.</p>
      <p id="firebase-warn" class="msg err"></p>
    </div>
  </main>

  <!-- EDIT PROFILE -->
  <section id="viewEdit" class="view" style="display:none">
    <h2>Edit Profile</h2>
    <div id="editGate" class="card warn">You must be registered/loged in</div>

    <div id="editContent" class="card" style="display:none">
      <div class="row pfp">
        <div class="flagSlot"><span id="flag">üè≥Ô∏è</span></div>
        <div class="pfpSlot">
          <img id="pfpImg" style="display:none"/>
        </div>
      </div>
      <div class="row">
        <button id="btnSetPfp">Set PFP (sekai.best)</button>
        <button id="btnClearPfp" class="ghost" style="display:none">Eliminar PFP</button>
      </div>
      <p id="edit-msg" class="msg"></p>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="viewLb" class="view" style="display:none">
    <h2>Leaderboard</h2>
    <div class="row">
      <div class="dropdown" id="rankDropdown">
        <button id="rankToggle"><span id="rankLabel">Rangos</span></button>
        <div id="rankMenu" class="menu"></div>
      </div>
      <button id="btnShowAll" class="ghost" style="display:none">Mostrar todo</button>
    </div>

    <table class="lb">
      <thead>
        <tr><th>#</th><th>Usuario</th><th>MMR</th><th>Rango</th></tr>
      </thead>
      <tbody id="lbBody"></tbody>
    </table>
  </section>

  <!-- Modal selector de cartas -->
  <dialog id="cardPicker">
    <h3>Selecciona tu carta</h3>
    <input id="cardSearch" placeholder="Buscar carta..." />
    <div id="cardGrid"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="closePicker" class="ghost">Cerrar</button>
    </div>
  </dialog>

  <!-- ====================== APP SCRIPT ====================== -->
  <script type="module">
    /* ---------------- FIREBASE ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sendEmailVerification, sendPasswordResetEmail,
      updateProfile, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      /* üëâ Pega tu configuraci√≥n real de Firebase Web App */
      apiKey: "AIza...REEMPLAZA...",
      authDomain: "tu-proyecto.firebaseapp.com",
      projectId: "tu-proyecto",
      storageBucket: "tu-proyecto.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef",
    };

    try {
      if (!firebaseConfig.apiKey || !/^AIza/.test(firebaseConfig.apiKey)) {
        document.getElementById("firebase-warn").textContent =
          "Error al registrar: Firebase: Error (auth/api-key-not-valid.-please-pass-a-valid-api-key.). Revisa tu 'firebaseConfig' y 'Authorized domains'.";
      }
    } catch {}

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    /* -------------- CONSTANTES / HELPERS -------------- */
    const DISCORD_CLIENT_ID = "TU_CLIENT_ID";
    const DISCORD_REDIRECT_URI = "https://TU_DOMINIO/auth/discord"; // igual al de Discord Dev Portal
    const OAUTH_FN_URL = "https://us-central1-TU_PROYECTO.cloudfunctions.net/discordToken";

    const $ = s => document.querySelector(s);
    const show = (el, v=true)=> el.style.display = v? "": "none";
    const norm = s => String(s||"").trim().toLowerCase();

    const RANGE_LABEL = {
      Iron:"Iron  (‚Üì0-100)", Bronze:"Bronze (101-200)", Silver:"Silver (201-300)",
      Gold:"Gold (301-400)", Platinum:"Platinum (401-500)", Diamond:"Diamond (501-600)",
      Crystal:"Crystal (601-700)", Master:"Master (701-800)", Champion:"Champion (801-900)",
      GrandChampion:"GrandChampion (901-999)", Legend:"Legend (‚Üë1000)"
    };
    const RANGES = [
      { key:"Iron",min:0,max:100 },{ key:"Bronze",min:101,max:200 },
      { key:"Silver",min:201,max:300 },{ key:"Gold",min:301,max:400 },
      { key:"Platinum",min:401,max:500 },{ key:"Diamond",min:501,max:600 },
      { key:"Crystal",min:601,max:700 },{ key:"Master",min:701,max:800 },
      { key:"Champion",min:801,max:900 },{ key:"GrandChampion",min:901,max:999 },
      { key:"Legend",min:1000,max:Infinity }
    ];

    // Datos demo (c√°mbialos por los reales)
    let ALL_PLAYERS = [
      { id:1, name:"alpha", mmr:120, rank:"Bronze" },
      { id:2, name:"beta", mmr:505, rank:"Diamond" },
      { id:3, name:"gamma", mmr:980, rank:"GrandChampion" },
      { id:4, name:"delta", mmr:1005, rank:"Legend" },
      { id:5, name:"epsilon", mmr:320, rank:"Gold" },
    ];
    let currentFilter = null;

    async function loadProfile(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return { id: uid, ...snap.data() };
    }
    async function ensureProfile(uid, base){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        await setDoc(ref, { createdAt: serverTimestamp(), ...base });
      }else if (base && Object.keys(base).length){
        await updateDoc(ref, base);
      }
      return loadProfile(uid);
    }

    /* ---------------- REGISTER ---------------- */
    $("#btnRegister").addEventListener("click", async ()=>{
      const username = $("#rg-username").value.trim();
      const email = $("#rg-email").value.trim();
      const pass = $("#rg-pass").value;
      $("#rg-msg").textContent = "";

      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: username });

        const deadline = Date.now() + 5*60*1000;
        await ensureProfile(cred.user.uid, {
          email, usernameDesired: username,
          discordLinked:false, discord:null, pfpUrl:null,
          verificationSentAt: Date.now(), verifyDeadline: deadline
        });

        await sendEmailVerification(cred.user, { url: location.origin, handleCodeInApp:false });
        $("#rg-msg").innerHTML = "Cuenta creada. <span class='ok'>Se envi√≥ verificaci√≥n</span> (tienes 5 minutos). Vincula tu Discord para habilitar PFP.";
      }catch(e){
        $("#rg-msg").innerHTML = `<span class='err'>Error al registrar:</span> ${e.message}`;
      }
    });

    /* ---------------- LOGIN ---------------- */
    $("#btnLogin").addEventListener("click", async ()=>{
      const username = $("#li-username").value.trim();
      const email = $("#li-email").value.trim();
      const pass = $("#li-pass").value;
      $("#li-msg").textContent = "";

      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await ensureProfile(cred.user.uid, { lastLoginAt: Date.now(), usernameDesired: username || cred.user.displayName || "" });

        if (!cred.user.emailVerified){
          const deadline = Date.now() + 5*60*1000;
          await updateDoc(doc(db,"users",cred.user.uid), { verificationSentAt: Date.now(), verifyDeadline: deadline });
          await sendEmailVerification(cred.user, { url: location.origin, handleCodeInApp:false });
          $("#li-msg").textContent = "Verifica tu correo en los pr√≥ximos 5 minutos para habilitar funcionalidades.";
          startVerifyWatcher(deadline);
        }else{
          $("#li-msg").textContent = "Sesi√≥n iniciada.";
        }
      }catch(e){
        $("#li-msg").innerHTML = `<span class='err'>Error al iniciar sesi√≥n:</span> ${e.message}`;
      }
    });

    $("#btnReset").addEventListener("click", async ()=>{
      const email = $("#li-email").value.trim();
      if (!email){ alert("Ingresa tu email para enviar el reset."); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        $("#li-msg").textContent = "Hemos enviado un correo para resetear tu contrase√±a.";
      }catch(e){
        $("#li-msg").innerHTML = `<span class='err'>${e.message}</span>`;
      }
    });

    let verifyTimer = null;
    function startVerifyWatcher(deadline){
      clearInterval(verifyTimer);
      verifyTimer = setInterval(async ()=>{
        await auth.currentUser?.reload();
        const left = deadline - Date.now();
        if (auth.currentUser?.emailVerified){
          clearInterval(verifyTimer);
          $("#li-msg").textContent = "Email verificado ‚úî. Vincula tu Discord para editar PFP.";
          refreshGate();
          return;
        }
        if (left <= 0){
          clearInterval(verifyTimer);
          $("#li-msg").textContent = "Tiempo agotado. Vuelve a iniciar sesi√≥n y solicita verificaci√≥n.";
          await signOut(auth);
          refreshGate();
        }else{
          $("#li-msg").textContent = `Verifica tu correo. Tiempo restante: ${Math.ceil(left/1000)}s`;
        }
      }, 3000);
    }

    /* ---------------- DISCORD LINK (con PKCE + Function) ---------------- */
    $("#btnRegDiscord").addEventListener("click", linkDiscord);
    $("#btnLoginDiscord").addEventListener("click", linkDiscord);

    async function linkDiscord(){
      if (!auth.currentUser){ alert("Primero inicia sesi√≥n."); return; }
      const profile = await ensureProfile(auth.currentUser.uid, {});
      const desired = norm(profile?.usernameDesired || auth.currentUser.displayName);

      // PKCE
      const codeVerifier = [...crypto.getRandomValues(new Uint8Array(32))]
        .map(b=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~"[b%66]).join("");
      const enc = new TextEncoder().encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", enc);
      const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");

      const scope = "identify";
      const authUrl =
        `https://discord.com/api/oauth2/authorize?client_id=${encodeURIComponent(DISCORD_CLIENT_ID)}&response_type=code&redirect_uri=${encodeURIComponent(DISCORD_REDIRECT_URI)}&scope=${encodeURIComponent(scope)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;

      const popup = window.open(authUrl, "discord_oauth", "width=500,height=700");
      const code = await waitForCode(DISCORD_REDIRECT_URI);
      popup?.close();

      const res = await fetch(OAUTH_FN_URL, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ code, codeVerifier, redirectUri: DISCORD_REDIRECT_URI })
      });
      if (!res.ok){ const t = await res.text(); throw new Error("Discord OAuth error: "+t); }
      const data = await res.json(); // { user: {id, username, global_name, avatarUrl} }

      const discordName = norm(data.user.global_name || data.user.username);
      if (desired && discordName && desired !== discordName){
        alert(`El username no coincide.\nIngresaste: "${profile.usernameDesired}"\nDiscord: "${data.user.global_name||data.user.username}"`);
        return;
      }

      await updateDoc(doc(db,"users",auth.currentUser.uid), {
        discordLinked:true, discord: data.user
      });
      alert("Discord vinculado ‚úî. Ya puedes editar tu PFP.");
      refreshGate();
    }

    function waitForCode(redirectUri){
      return new Promise(resolve=>{
        function onMsg(e){
          if (typeof e.data === "object" && e.data.type==="discord_code"){
            window.removeEventListener("message", onMsg);
            resolve(e.data.code);
          }
        }
        window.addEventListener("message", onMsg);
      });
    }

    /* ---------------- EDIT PROFILE + PFP ---------------- */
    $("#btnSetPfp").addEventListener("click", async ()=>{
      const ok = await checkGate(); if (!ok) return;
      $("#cardPicker").showModal();
      loadCards();
    });
    $("#closePicker").addEventListener("click", ()=> $("#cardPicker").close());
    $("#btnClearPfp").addEventListener("click", async ()=>{
      if (!auth.currentUser) return;
      await updateDoc(doc(db,"users",auth.currentUser.uid), { pfpUrl: null });
      $("#pfpImg").style.display="none"; $("#btnClearPfp").style.display="none";
      $("#edit-msg").textContent = "PFP eliminado.";
    });

    const CARDS_ENDPOINT = "https://sekai.best/api/cards.json"; // ajusta si cambia
    let ALL_CARDS = [];
    async function loadCards(){
      const grid = $("#cardGrid");
      if (ALL_CARDS.length === 0){
        try{
          const r = await fetch(CARDS_ENDPOINT);
          ALL_CARDS = await r.json();
        }catch{
          grid.innerHTML = "<p>No pude cargar cartas autom√°ticamente. Abre sekai.best/card y pega la URL de la imagen entrenada o no entrenada.</p>";
          return;
        }
      }
      renderCards(ALL_CARDS);
    }
    function renderCards(list){
      const grid = $("#cardGrid"); grid.innerHTML = "";
      list.forEach(c=>{
        const url = c.trainedArt || c.normalArt || c.asset || c.image || "";
        if (!url) return;
        const div = document.createElement("div");
        div.className = "cardItem";
        div.innerHTML = `<img src="${url}" alt="card ${c.id}"/><div>#${c.id} ${c.title||""}</div>`;
        div.onclick = async ()=>{
          if (!auth.currentUser) return;
          await updateDoc(doc(db,"users",auth.currentUser.uid), { pfpUrl: url });
          $("#pfpImg").src = url; $("#pfpImg").style.display=""; $("#btnClearPfp").style.display="";
          $("#edit-msg").textContent = "PFP actualizado ‚úî";
          $("#cardPicker").close();
        };
        grid.appendChild(div);
      });
    }
    $("#cardSearch").addEventListener("input", e=>{
      const q = norm(e.target.value);
      const filtered = ALL_CARDS.filter(c=>{
        const text = norm(`${c.id} ${c.title||""} ${c.character||""} ${c.rarity||""}`);
        return text.includes(q);
      });
      renderCards(filtered);
    });

    async function checkGate(){
      if (!auth.currentUser){ gate("You must be registered/loged in"); return false; }
      await auth.currentUser.reload();
      const prof = await ensureProfile(auth.currentUser.uid, {});
      if (!auth.currentUser.emailVerified){
        gate("Verifica tu correo (tienes 5 minutos desde que lo solicitaste)."); return false;
      }
      if (!prof?.discordLinked){
        gate("Vincula tu Discord para habilitar PFP."); return false;
      }
      gate(null); return true;
    }
    function gate(msg){
      if (msg){ $("#editGate").textContent = msg; show($("#editGate"), true); show($("#editContent"), false); }
      else { show($("#editGate"), false); show($("#editContent"), true); }
    }
    async function refreshGate(){
      const ok = await checkGate();
      if (ok && auth.currentUser){
        const prof = await loadProfile(auth.currentUser.uid);
        if (prof?.pfpUrl){
          $("#pfpImg").src = prof.pfpUrl; $("#pfpImg").style.display=""; $("#btnClearPfp").style.display="";
        }else{
          $("#pfpImg").style.display="none"; $("#btnClearPfp").style.display="none";
        }
      }
    }

    onAuthStateChanged(auth, async (u)=>{ await refreshGate(); });

    /* ---------------- NAV ---------------- */
    function showView(id){
      ["#viewHome","#viewLb","#viewEdit"].forEach(s=> show($(s), s===id));
      ["#navHome","#navLb","#navEdit"].forEach(s=> $(s).classList.remove("active"));
      if (id==="#viewHome") $("#navHome").classList.add("active");
      if (id==="#viewLb")   $("#navLb").classList.add("active");
      if (id==="#viewEdit") $("#navEdit").classList.add("active");
    }
    $("#navHome").onclick = ()=> showView("#viewHome");
    $("#navLb").onclick   = ()=> { showView("#viewLb"); renderLeaderboard(); };
    $("#navEdit").onclick = ()=> showView("#viewEdit");

    /* ---------------- LEADERBOARD ---------------- */
    function inRange(mmr, r){ return mmr>=r.min && mmr<=r.max; }

    function buildRankMenu(){
      const menu = $("#rankMenu"); menu.innerHTML = "";
      for(const r of RANGES){
        const cnt = ALL_PLAYERS.filter(p=> inRange(p.mmr, r)).length;
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `<span class="gradtext rank-${r.key}">${RANGE_LABEL[r.key]}</span><span>${cnt}</span>`;
        item.onclick = ()=>{
          currentFilter = r;
          $("#rankLabel").innerHTML = `<span class="gradtext rank-${r.key}">${r.key}</span> (${cnt})`;
          show($("#btnShowAll"), true);
          renderLeaderboard();
          $("#rankMenu").style.display="none";
        };
        menu.appendChild(item);
      }
    }

    $("#rankToggle").addEventListener("click", ()=>{
      const m = $("#rankMenu");
      m.style.display = (m.style.display==="block"?"none":"block");
    });
    document.addEventListener("click",(e)=>{
      if (!$("#rankDropdown").contains(e.target)) $("#rankMenu").style.display="none";
    });
    $("#btnShowAll").addEventListener("click", ()=>{
      currentFilter = null; $("#rankLabel").textContent = "Rangos"; show($("#btnShowAll"), false); renderLeaderboard();
    });

    function renderLeaderboard(){
      buildRankMenu();
      const body = $("#lbBody"); body.innerHTML = "";
      const list = (currentFilter? ALL_PLAYERS.filter(p=> inRange(p.mmr, currentFilter)): ALL_PLAYERS)
        .sort((a,b)=> b.mmr - a.mmr);
      list.forEach((p,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${p.name}</td>
          <td>${p.mmr}</td>
          <td><span class="gradtext rank-${p.rank}">${p.rank}</span></td>
        `;
        body.appendChild(tr);
      });
    }
    renderLeaderboard();
  </script>

  <!-- P√°gina de retorno para Discord (col√≥cala en /auth/discord) :
       Debe postMessage({type:"discord_code", code}) al opener -->
  <!-- EJEMPLO (sirve si no usas router):
  <script>
    (function(){
      const q = new URLSearchParams(location.search);
      if (q.get("code") && window.opener){
        window.opener.postMessage({ type:"discord_code", code: q.get("code") }, "*");
        document.write("Puedes cerrar esta ventana.");
      }
    })();
  </script>
  -->
</body>
</html>

